关于智能家居方案
邹业盛
%%mtime(%Y-%m-%d %H:%M)
%!encoding: utf-8
%!options(xhtml): --google-analytics --disqus
%!qr: http://www.zouyesheng.com/iot.html
%!format: !email
%%toc


# 前面吐槽 #

去年搞过完整的一遍智能家居方案后，本来是想记录一下的，不过这东西比较散，后面也难得起笔了。

结果前几天，网上看到一个帖子，说 160 平的房子，找华为的智能家居方案，直接报价 7 万多。我就说，“这就是骗傻子的。除非是服务费。”然后大概以我做过的方案算了一下买设备的费用，不超过 4000 。

然后一堆屁话就来了：

- 华为的是有线，技术先进，稳定。什么 PLC ，电力载波。
- 小米的不好，不稳定。
- 华为的是企业级服务，牛逼着呢。深圳有多少办公楼都是用的这套方案。


其实我本来只是随便吐槽一下这个 7 万的方案的，报价的很可能只是某些经销商，和华为也没多大关系。就算是服务费高，把东西做好了，有人愿意付费，也无可厚非。不过现在网上的 SB 比以前多得多了，没逻辑，喜欢搞对立。

不巧，我自己才做过智能家居方案，十几年前也接触过电力载波，还知道所谓的企业级服务是什么货色。

先说结论吧：就是骗傻子的。

上面三点，都不成立：

- 电力载波的有线方案在家居场景中没任何意义，因为控制信号传输需要 1ms 还是 100ms ，相对于传感器的精度和“反应”时间都不值一提。更讽刺的是，市面上根本没有支持电力载波的设备（吸顶灯都没有），能找到的支持华为 HiLink 的传感器，用的还是 zigbee 无线协议，还要单独买网关。
- 小米搭配本地的中枢网关，足够稳定。当然，依赖公网的设备，自家的网络要处理好。
- 企业级服务对于个人没有任何意义。办公楼装修，谈好了方案和价格，啥都可以定制。但是个人，你在淘宝上却买不到支持 HiLink 的亳米波传感器和红外信号发射器。


总结这些回复就是：技术忽悠，生态拉跨。还喜欢恶意造谣竞争对手。

吐槽完了，开始正题吧。


# 什么是智能家居？ #

大部分人能接触到的，可能就是“天猫精灵放个屁”和可以在手机上控制空调吧，开个玩笑。

我倒不觉得这里面有多少“智能”的成份，核心只是“互联”而已。只要联上了，控制就好办了。只要联上了，设备间的互动，也好办。

那么基于这个最核心的拆求，各家都在拼命做自己的标准，平台。目前市面上有：米家，天猫精灵，小度，涂鸦，华为 HiLink ，苹果的 HomeKit ，Google Home 等，有些方案会考虑互通。

也有开源的项目，比如 Homeassistant https://www.home-assistant.io/ ，它可以把各平台的设备统一纳入管理（某些设备需要一点“魔法”）。

所以，如果要弄智能家居，首先选定一个平台，因为后面你需要去购买支持这个平台的各类电器（不支持的也有办法）。


# 需要提前设计吗？ #

准备说，是需要在装修阶段针对性地设计吗？不需要。

智能家居方案，对电路没有要求。你可能听说过需要零线的“智能开关”，嗯，固定的灯开关本身就是多余的，所以不用纠结它。换句话讲，在装修阶段，倒是可以考虑取消所有灯开关。我甚至觉得，如果你都还在用固定开关，那就是智能了个寂寞。

在设计实施后之后，绝大部分场景下，灯的控制，是可以通过传感器自动处理的。即使个别场景需要人为控制，也可以使用各种可以随身带的，装电池的，支持自定义的智能开关。每个人也可以根据自己的习惯使用不同的开关。退一步，还有手机呢，它能控制所有设备。


# 怎么实施？ #

首先，前面讲过，要选定一个平台。

然后，比较重要的，去购买支持这个平台的灯和电器。灯是影响日常体验最重要的一部分。米家的生态好，我知道的，松下的灯和小米自家的灯都有。电器主要留意一些功率大又没有遥控的东西，比如浴室暖风机，油烟机。

如果是旧灯，又没有遥控，有一个方案是淘宝买一个支持蓝牙 Mesh 的通断器，接到灯的电路上。这个通断器接入米家，就可以统一控制灯的电路通断了。

冰箱，洗衣机这类，我个人是觉得没啥支持的必要。

空调，电视等有遥控器的电器，如果原本不支持，解决方案是淘宝买红外信号发射器，它可以学习遥控器的信号，作为原遥控器的替换。然后它支持米家接入，就解决问题了。也可以直接买带红外信号发射功能的小米音响。

剩下的额外场景，可以用“智能插座”解决。这东西一般是标准的五孔插座，可以接入米家。米家控制它的通断，就可以控制插在它上面的电器的通断。比如我买过一个大的落地扇，要买纯机械开关的。（对应的一些设备，是电子开关。比如，本来是运行状态，这时你把插头拔了，再插回去时，它不能回到运行状态，又重置成待机状态了，需要重新按一下。这种就对接不了了。）

电器处理好了，接下来把设备网关（比如米家的那个中枢网关）和路由器配置好，就可以工作了。

这个阶段，可以考虑一下是否需要智能音响，是否每个房间需要一个。它的作用（我用过的）：

- 红外信号发射器。所以，客厅放一个带红外信号发射功能的，需要的时候可以帮助接入电视和空调。（红外线没有穿墙能力）
- 语音控制。开灯关灯，开空调关空调之类的。不过注意，语音控制的局限可能比你想象的大，家里有人时不方便用，晚上不方便用之类。
- 交互反馈。当你执行了某些触发功能的时候，如果你能听到音响当中的反馈，体验是比较好的，如：“准备离家，现在是早上 8 点。今天有雨。麦克风即将关闭，监控就绪。”
- 其它功能。如：“今天天气怎么样？”，“XX 地方未来三天天气怎么样？”，“计时 10 分钟”（厨房做饭）。


做到这里了，不少人就至此为止了。这些电器，设备，手机上都能控制。

接下来的传感器，才是有点折腾的部分。


# 配置传感器 #

目前市面上可以买到的传感器有：门窗开关，人体探测（红外线），人体探测（毫米波），温度，光照，水浸。

这里面，门窗开关和人体探测都集成了简单光照传感器。除了人体探测（毫米波）其它的传感器都是使用钮扣电池。红外线最大的局限是只能探测活动的物体。

水浸传感器我只用于提醒忘记关窗时碰到下雨的情况，温度传感器（蓝牙的温度计）我还没有配置过任何的触发事件。

所以，现在所谓的智能家居，就变成仅仅是把门窗开关和人体探测两种传感器配置好了。而多想一下，不难想到，所有场景其实仅仅是人体探测传感器的配置问题。但是，现在市面上的人体探测传感器的准确度并不是十分可靠，于是，在某些情况下，配合可靠的门窗开关传感器，也许问题就变得很简单了。


## 离家和回家 ##

“离家”和“回家”的识别，是我碰到的最难处理的场景，而这两个场景偏偏是非常影响体验的场景。最后我是直接放弃，用另外的方式处理的。不过从另一个角度说，“离家”和“回家”搞明白了，就直接对传感器配置有了完整的概念。

考虑一下“离家”发生时，我们希望做什么？

- 关闭所有灯。
- 关闭所有空调。
- 关闭电视。
- 打开监控。
- 打开窗帘。（当温度过高时关闭窗帘）
- 降下晾衣架。（当光照足够的时候）
- 关闭智能音响的麦克风。
- 关闭所有窗户。（就想一下，目前没有简单且经济的方案）
- 智能音响提示当前时间，今日是否有雨。


再考虑一下“回家”时，希望做什么？

- 打开玄关灯。
- 升起晾衣架。
- 打开智能音响麦克风。
- 智能音响提示当前时间和欢迎语。
- 关闭监控。（后面会说，并不应该在这里关闭）
- 打开其它的某些灯。（如果光照不足够）


这两个场景，是非常典型的场景，也算是最复杂的场景了，上面考虑的操作非常多。但是，先说结论，“离家”是无法自动判断的。

最开始，即使只有我一个人，用“开门”，“关门”来判断“离家”，碰到开门拿快递就失效了。后面考虑屋里有多人的情况时，意识到这个问题的困难。直观地，如果全屋有足够的人体探测传感器，并且这些传感器的准确度足够，那么当所有人体传感器都是“无人”状态时，可以得到“离家”状态的确认。

但是事实上，这是不可能的。第一个困难点，是为了这个场景在全屋布满传感器，是不经济的做法。第二个困难点，是“状态”的保存与获取，这涉及到具体的传感器产品的功能问题。小米的那个红外线人体探测，“N分钟无人”只能是事件触发，它没有“无人”状态的获取功能，可能是为了功耗考虑？所以无人判断行不通。（虽然我们有办法，利用其它设备，来“记录”状态）

最后，我的方案就是，在玄关那里，利用插座和开关，专门做了一个“离家”提示器。平时，在插座上插一个小夜灯，当“离家”时，人为地关闭这个灯，就准确传达了“离家”的触发事件。“离家”明确了，“回家”就简单了——在“离家”状态下，开门了，就是“回家”触发。

















