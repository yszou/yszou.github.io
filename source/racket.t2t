Racket è¯­è¨€å­¦ä¹ å‚è€ƒ
é‚¹ä¸šç››
%%mtime(%Y-%m-%d %H:%M)
%!encoding: utf-8
%!options(xhtml): --google-analytics --disqus
%!qr: http://www.zouyesheng.com/racket.html
%!format: !email
%%toc


# å®‰è£…ä¸ç®€ä»‹ #

*racket* æ˜¯ä¸€ä¸ªæ¯”è¾ƒç°ä»£åŒ–çš„ *scheme* è¯­è¨€ã€‚å®ƒçš„ Hello World æ˜¯è¿™æ ·çš„ï¼š

```racket
#lang racket  

(display "helloworld")
```

å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```bash
sudo apt-get install racket
```

è¿›è¡Œå®‰è£…ï¼Œå®Œæˆä¹‹åï¼Œæœ‰ä¸€ä¸ª ``racket`` çš„å¯æ‰§è¡Œç¨‹åº/REPL ï¼ŒåŠ ``drracket`` è¿™ä¸ªå¼€å‘ç¯å¢ƒ/IDEã€‚

``racket`` å¯ä»¥ç›´æ¥æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚ï¼š

```bash
racket /home/zys/temp/demo.rkt
```

*racket* æä¾›äº†ç¼–è¯‘å™¨ï¼Œå¯ä»¥ç›´æ¥ç¼–è¯‘å¾—åˆ°å¯æ‰§è¡Œç¨‹åºã€‚


# åŸºæœ¬è¯­æ³• #

## åœ†æ‹¬å·å’Œæ–¹æ‹¬å· ##

*scheme* æ˜¯ç”¨ S è¡¨è¾¾å¼æ¥ç»„æˆçš„ï¼Œ *racket* ä¸­è¿™ç‚¹å¹¶æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯ *racket* ä¸­çš„ S è¡¨è¾¾å¼ï¼ŒåŒæ—¶æ”¯æŒåœ†æ‹¬å· ``()`` å’Œæ–¹æ‹¬å· ``[]`` ï¼Œè¿™ä¸ªæœºåˆ¶ï¼Œåœ¨æ‹¬å·åµŒå¥—åœºæ™¯ä¸‹ï¼Œå¯ä»¥æä¾›æ›´å¥½çš„è§†è§‰è¯†åˆ«ï¼Œå¦‚ï¼š

```racket
#lang racket  

(define [add1 a b] [+ a b])
(define (add2 a b) (+ a b))

(add1 1 2)
(add2 1 2)
```

## æ³¨é‡Š ##

```racket
#lang racket  

;è¿™æ˜¯ä¼ ç»Ÿçš„å•è¡Œæ³¨é‡Š

#| 
è¿™æ˜¯ racket çš„ï¼Œå¯ä»¥å¤šè¡Œçš„ï¼Œ
    #|
        å¯ä»¥åµŒå¥—çš„æ³¨é‡Š
    |#
|#

#; æ³¨é‡Šä¸€ä¸ª "å•è¯­æ³•å•å…ƒ"
#;(display
    123) (display "1\n")
#;1 2 (display "2\n")
```

``#;`` çš„è¡Œä¸ºæ¯”è¾ƒç‰¹æ®Šï¼Œå…¶å®ƒè¯­è¨€ä¸­æ˜¯æ²¡æœ‰çš„ã€‚


## åŸºæœ¬æ•°æ®ç±»å‹ ##

```racket
#lang racket  

1
3.14
1/3
(+ 1/3 1/3)
6.02e+23
1+2i
#t
#f
"string"
"string\"ss\""
(display "string\"ss\"\n")
"Î»x:(Î¼Î±.Î±â†’Î±).xx"
"ã€â–¶ğŸ˜€ğŸ˜‚"
(display "ã€â–¶ğŸ˜€ğŸ˜‚\n")
```

åŸºæœ¬æ•°æ®ç±»å‹æœ‰ï¼šæ•´æ•°ï¼Œå°æ•°ï¼Œå®æ•°ï¼Œå¤æ•°ï¼Œå¸ƒå°”é‡ï¼ŒUnicode å­—ç¬¦ä¸²ã€‚

åé¢è¿˜ä¼šä¸“é—¨å¯¹å†…ç½®çš„æ•°æ®ç±»å‹ä½œä»‹ç»ã€‚


## é€»è¾‘è¿ç®—ï¼Œæ¡ä»¶åˆ¤æ–­ ##

TODO


## å®šä¹‰ä¸å‡½æ•°ï¼ŒåŒ¿åå‡½æ•° ##

*å®šä¹‰* ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ ``define`` ï¼Œå…¶å®åº”è¯¥è¯´ *ç»‘å®š* çš„ï¼š

```racket
#lang racket  

(define a 1)
(define b 2)
(+ a b)
```

åƒæ˜¯èµ‹å€¼ï¼Œä½†æ˜¯ä¸èƒ½å¯¹åŒä¸€ä¸ª *æ ‡è¯†* ï¼Œè¿›è¡Œé‡å¤çš„ ``define`` ã€‚

``define`` ä¹Ÿå¯ä»¥ç”¨äºå‡½æ•°çš„å®šä¹‰ï¼š

```
#lang racket  

(define [add a b] [+ a b])
(add 1 2)
```

ä½¿ç”¨ ``labmda`` çš„åŒ¿åå‡½æ•°ä¹Ÿè¡Œï¼š

```racket
#lang racket  

(define add [lambda (a b) (+ a b)])
(add 1 2)
```

## åˆ—è¡¨ï¼Œè¿­ä»£ ##

*åˆ—è¡¨* ï¼Œæ˜¯ *scheme* è¿™ç±»è¯­è¨€ï¼Œæœ€æ ¸å¿ƒçš„ä¸€ç§æ•°æ®ç»“æ„ã€‚å› ä¸ºï¼Œæˆ‘ä»¬å†™çš„ä»£ç ï¼Œæœ¬èº«å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ *åˆ—è¡¨* ã€‚è¿™ä¸ªæ€§è´¨æ˜¯ä¸€èˆ¬å¤§ä¼—åŒ–çš„è¯­è¨€æ²¡æœ‰çš„ã€‚


```racket
#lang racket  

(define add [lambda (a b) (+ a b)])
(add 1 2)

'(add 1 2)
'("add" "1" "2")
(list add 1 2)
(list "add" 1 2)
```

``list`` å‡½æ•°ï¼Œå’Œ ``'`` å‰ç¼€ï¼Œæ˜¯åŒæ ·çš„ä½œç”¨ï¼Œå°±æ˜¯å¾—åˆ°ä¸€ä¸ªåˆ—è¡¨ã€‚

*racket* å†…ç½®äº†å¾ˆå¤šé’ˆå¯¹åˆ—è¡¨çš„å‡½æ•°ï¼š

```racket
#lang racket  

(define any '(1 2 3 add "add"))
any
(length any)
(list-ref any 0)
(list-ref any 3)
(append any "1")
(append any '(2 "good"))
(reverse any)
```

``append`` çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç±»å‹ä¸åŒï¼Œç»“æœæ˜¯ä¸åŒçš„ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸æ˜¯ *list* ï¼Œåˆ™ä¼šå¾—åˆ°ä¸€ä¸ª *Pair* ã€‚


*è¿­ä»£* çš„æ¦‚å¿µï¼Œç±»ä¼¼äºå…¶å®ƒè¯­è¨€ä¸­çš„é‚£ä¸€å †â€œå‡½æ•°å¼â€æ–¹æ³•ï¼Œåƒ ``map`` ``filter`` ``reduce`` ä¹‹ç±»çš„ã€‚

*racket* ä¸­æœ‰ ``map`` ``filter`` ``foldl`` ``andmap`` ``ormap`` ã€‚

```racket
#lang racket  

(map [lambda (n) (* n 2)] '[1 2 3 4 5])
(filter [lambda (n) (> n 4)] '[1 3 4 5 6 7 8])
(foldl [lambda (a b) (+ a b)] 0 '[1 2 3 4])
(andmap [lambda (n) (> n 4)] '[5 6])
(ormap [lambda (n) (> n 5)] '[5 6])
```

## åˆ—è¡¨ä¼ ç»Ÿ ##

``map`` ä¹‹ç±»çš„å‡½æ•°ï¼Œå¯¹äºâ€œè¿­ä»£â€æ¥è¯´ä¸æ˜¯å¿…é¡»çš„ï¼Œä¼ ç»Ÿä¸Šï¼Œåªéœ€è¦ ``car`` å’Œ ``cdr`` ä¸¤ä¸ªæ–¹æ³•å°±å¯ä»¥å®Œæˆå¯¹åˆ—è¡¨çš„éå†æ“ä½œï¼ŒåŸºäºå®ƒä»¬ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰ ``map`` ``filter`` ç­‰ã€‚åœ¨ *racket* ä¸­ï¼Œå¯¹åº”çš„æ–¹æ³•æ˜¯ ``first`` å’Œ ``rest`` ï¼š

```racket
#lang racket  

(first '(1 2 3))
(rest '(1 2 3))
(first (rest '(1 2 3)))
(define l (cons 2 (cons 1 empty)))
(first l)
(rest l)
(empty? empty)
(empty? '())
(empty? '(1))
(empty? 1)
```

è¦å†™ä¸ªç®€å•çš„ ``map`` å°±å¾ˆå®¹æ˜“äº†ï¼š

```racket
#lang racket  

(define (my-map f lst)
  (if [empty? lst]
    lst
    [cons (f [first lst]) (my-map f [rest lst])] ))

(my-map (lambda (n) (+ n 1)) '(1 2 3))
```

``car`` , ``cdr`` ï¼Œç”šè‡³æ˜¯ ``pair`` è¿™ç±»ä¼ ç»Ÿæ¦‚å¿µåœ¨ *racket* ä¸­éƒ½æ˜¯å­˜åœ¨çš„ï¼Œä¸è¿‡å¹¶ä¸éœ€è¦åˆ»æ„å»ä½¿ç”¨å°±æ˜¯äº†ï¼š

```racket
#lang racket  

(pair? (cons 1 2))
(list? (cons 1 2))
(cons 1 2)
(car (cons 1 2))
(cdr (cons 1 2))
(car '(1 2 3))
(cdr '(1 2 3))
```


## å°¾é€’å½’ ##

å‰é¢å†™çš„ ``my-map`` ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒç›´æ¥çš„å®ç°ï¼Œå®ƒé€šè¿‡é€’å½’çš„æ–¹å¼ï¼Œä¾æ¬¡æŠŠ ``my-map`` çš„ç»“æœä½œä¸º ``cons`` çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚è¿™ç§ç»“æ„ä¸‹ï¼Œåœ¨åå¤è‡ªè°ƒç”¨ ``my-map`` çš„æ—¶å€™ï¼Œéƒ½å¿…é¡»ä¿å­˜ä¸€ä¸ªçŠ¶æ€ï¼Œè¿™ä¸æ˜¯ä¸€ç§é«˜æ•ˆçš„è¡¨ç°ã€‚

æ”¹è¿›çš„åŠæ³•ï¼Œæ˜¯è®©åå¤è‡ªè°ƒç”¨ ``my-map`` æ—¶ï¼Œéƒ½ä¸ä¾èµ–å¤–éƒ¨çš„ä»»ä½•ä¿¡æ¯ï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½é€šè¿‡â€œå‚æ•°â€ä½“ç°ã€‚


```racket
#lang racket  

(define (my-map f lst)
  (define (iter f lst result)
    [if (empty? lst) (reverse result)
                         ;---------------------------;
      (iter f (rest lst) [cons (f (first lst)) result] )]
    )
  (iter f lst empty))

(my-map (lambda (n) (+ n 2)) '(1 2 3))
(my-map (lambda (n) (+ n 2)) empty)
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¯æ¬¡è‡ªè°ƒç”¨ ``my-app`` æ—¶ï¼Œéƒ½åœ¨å°å¿ƒåœ°æ„é€ å®Œæ•´çš„ ``result`` å‚æ•°ï¼Œè¿™æ ·ï¼Œå½“æœ€ç»ˆæ»¡è¶³ç»“æŸè¿­ä»£çš„æ¡ä»¶æ—¶ï¼Œç›´æ¥è¿”å› ``result`` å³å¯ï¼Œä¸éœ€è¦é¢å¤–çš„â€œå›æº¯â€è¿‡ç¨‹ã€‚


ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨å†…ç½®çš„ ``for/list`` ï¼ˆæˆ‘çŒœå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªå®ï¼‰æ¥å®Œæˆï¼š

```racket
#lang racket  

(define (my-map f lst)
             ;v;        ;v;
  (for/list ([i lst]) (f i)))

(my-map (lambda (i) (+ i 2)) '(1 2 3 4))
```

ç°åœ¨æˆ‘ä»¬å¹¶æ²¡æœ‰è®²è¿‡â€œå˜é‡â€ä¹‹ç±»çš„æ¦‚å¿µï¼Œåªæœ‰å‡½æ•°çš„â€œå‚æ•°â€ã€‚ä¸Šé¢ä»£ç ä¸­çš„ ``i`` ï¼Œè™½ç„¶çœ‹èµ·æ¥åƒâ€œå˜é‡â€ï¼Œä½†åœ¨å®å±•å¼€åï¼Œä¹Ÿå°±åªæ˜¯ä¸€ä¸ªå‡½æ•°å‚æ•°äº†ã€‚ä»å½¢å¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çŒœå‡ºï¼Œå¯¹äº ``for/list`` æ¥è¯´ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯å¯ä»¥æœ‰å¤šä¸ªè¿­ä»£çš„å–å€¼å¯¹ï¼Œè¿™äº›å–å€¼å¯¹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå½¢å¼ä¸Šçš„åå­—ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¼šè¢«â€œæ±‚å€¼â€ã€‚

å†™ä¸€äº›ä¾‹å­è¯•è¯•ï¼š

```racket
#lang racket  

(for/list ([a '(1 2 3)]) ((lambda (i) (+ i 2)) a))

(for/list ([a '(1 2 3)]
           [b (reverse '(1 2 3))])
  ([lambda (i k) (+ i k)] a b))
```

åœ¨ *racket* ä¸­ï¼Œå®ƒå¹¶ä¸é¿è®³ä½¿ç”¨é€’å½’ï¼Œä¸æ˜¯è¯´ä¸€å®šè¦å°½é‡ä½¿ç”¨â€œè¿­ä»£â€ï¼ˆè¿­ä»£åªæ˜¯é€’å½’çš„ä¸€ç§ç‰¹æ®Šå½¢å¼è€Œå·²ï¼‰ã€‚åŒæ—¶ï¼Œå› ä¸ºè¯­è¨€æœºåˆ¶ï¼Œåœ¨ *racket* ä¸­å¹¶ä¸ä¼šæœ‰ *stack overflow* é—®é¢˜ï¼ˆä½†æ˜¯ä»ç„¶ä¼šä½¿ç”¨é¢å¤–çš„æ›´å¤šå†…å­˜ï¼‰ã€‚


## ä¸­ç¼€è¯­æ³• ##

è¿™ä¸ªï¼Œæ„Ÿè§‰åƒæ˜¯ *racket* è‡ªå·±ç©èŠ±æ´»ï¼Œé€šè¿‡â€œç‚¹â€ç¬¦å·ï¼Œ *racket* å®šä¹‰äº†ä¸€ç§ä¸­ç¼€è¡¨è¾¾å¼çš„æ ¼å¼ï¼š

```racket
#lang racket  

( (1 . + . 1) . + . 2 )
'(1 . + . 2)

(define (times base n) (base . * . n))
(10 . times . 2)
```

è¿™ç§è¡¨è¾¾å¼ï¼Œå¯ä»¥ç‰¹å®šä½¿ç”¨åœ¨ï¼Œæ¥æ”¶ 2 ä¸ªå‚æ•°çš„å‡½æ•°ä¸Šã€‚


# æ•°æ®ç±»å‹ #

## å¸ƒå°”å€¼ ##

``#t`` ``#f`` ``#T`` ``#F`` ï¼Œæ˜¯å¸ƒå°”å€¼ã€‚åœ¨é€»è¾‘åˆ¤æ–­ä¸­ï¼Œæ‰€æœ‰ä¸æ˜¯ ``#f`` ``#F`` çš„ï¼Œéƒ½ä¼šè¢«è®¤ä¸ºæ˜¯ ``#t`` ã€‚

ä½¿ç”¨ ``boolean?`` å¯ä»¥åšç²¾ç¡®çš„ç±»å‹åˆ¤æ–­ï¼š

```
#lang racket  

(boolean? #t)
(boolean? #T)
(boolean? 1)
(boolean? (not 1))
```


## æ•°å­— ##

æ•°å­—çš„æƒ…å†µåœ¨ *racket* ä¸­å¤æ‚ä¸€äº›ã€‚

ä¼ ç»Ÿä¸Šï¼Œæˆ‘ä»¬ç†è§£æ•°å­—ç±»å‹ï¼Œå¯ä»¥åˆ†æˆ æ•´æ•°ï¼Œæµ®ç‚¹æ•°ï¼Œä¹‹ç±»çš„ã€‚ *racket* ä¸­ä¹Ÿæœ‰è¿™äº›æ¦‚å¿µï¼Œä½†åœ¨å®ƒä»¬ä¹‹ä¸Šï¼Œ *racket* ä¸­çš„æ•°å­—è¿˜è¢«åˆ†æˆâ€œç²¾ç¡®æ•°å­—â€ *exact* å’Œâ€œéç²¾ç¡®æ•°å­—â€ *inexact* ã€‚

åˆ†æ•°çš„ ``1/2`` å’Œæµ®ç‚¹æ•°çš„ ``0.5`` ï¼Œæ˜¯ä¸åŒçš„ã€‚ ``1/2`` æ˜¯ *exact* ï¼Œè€Œ ``0.5`` æ˜¯ *inexact* ã€‚

ç²¾ç¡®çš„æ•°å­—ç±»å‹æœ‰è¿™äº›ï¼š

- æ•´æ•°ï¼Œ ``1``, ``999999``, ``-12``
- åˆ†æ•°ï¼Œ ``1/2``, ``-3/5``
- å¤æ•°ï¼Œ ``1+2i`` , ``1/3-2/5j``


ä¸ç²¾ç¡®çš„æ•°å­—ç±»å‹æœ‰ï¼š

- æµ®ç‚¹ï¼Œ ``2.0``,  ``3.14e+10``
- æ— é™ï¼Œ ``+inf.0`` , ``-inf.0`` ï¼ˆå¿…é¡»æ˜¯è¿™ä¸¤ä¸ªï¼‰
- éæ•°å­—ï¼Œ ``+nan.0``, ``-nan.0``
- å¤æ•°ï¼Œ ``2.1+3.0i``, ``-inf.0+nan.0i``


åœ¨ä¹¦å†™æ—¶ï¼Œå¯ä»¥æ˜ç¡®è¡¨ç¤ºæ˜¯å¦ *exact* ï¼Œä½¿ç”¨ ``#e`` æˆ–è€… ``#i`` ï¼Œ *racket* å¯ä»¥è‡ªåŠ¨è½¬æ¢ï¼š

```racket
#e0.5 ;1/2
#i1/2 ;0.5
#e0.1 ;1/10
```

äºŒè¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼Œåå…­è¿›åˆ¶ï¼Œåˆ†åˆ«ä½¿ç”¨ ``#b``, ``#o``, ``#x`` ï¼š

```
#xFF ;255
#b100100 ;36
#o10 ;8
```

ç²¾ç¡®å€¼å’Œéç²¾ç¡®å€¼ä¹‹é—´ä½¿ç”¨ ``exact->inexact`` å’Œ ``inexact->exact`` è½¬æ¢ï¼š

```racket
(exact->inexact 1/3)
(inexact->exact 0.3333) ;éå¸¸å¤§çš„ä¸¤ä¸ªæ•´æ•°ç›¸é™¤
```

ä¸åŒç±»å‹çš„æ€§èƒ½è¡¨ç°æ–¹é¢ï¼š å°çš„æ•´æ•° > æµ®ç‚¹ > è¶…å¤§æ•´æ•°å’Œå…¶å®ƒç²¾ç¡®æ•°


æ•°å­—çš„æ¯”è¾ƒï¼Œä¸€èˆ¬æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œ ``=`` å’Œ ``eqv?`` ï¼Œå‰è€…ä¼šå°è¯•è½¬æ¢åˆ°ç²¾ç¡®å€¼åå†æ¯”è¾ƒï¼Œåè€…ä¸ä¼šï¼š

```racket
(= 1 1.0) ;t
(= 1/3 0.333333) ;f
(eqv? 1 1.0) ;f
(eqv? 1 3/3) ;t
```

## å­—ç¬¦å’Œå­—ç¬¦ä¸² ##

*racket* ä¸­çš„ *å­—ç¬¦* æŒ‡ä¸€ä¸ª Unicode å€¼ã€‚å¯ä»¥ä½¿ç”¨ ``#\`` ï¼Œ ``#\u`` , ``#\space`` ``#\newline`` è¿™äº›è¡¨ç¤ºæ³•ã€‚åŒæ—¶ï¼Œä½¿ç”¨ ``char->integer`` å’Œ ``integer->char`` å®Œæˆæ•°å­—å’Œå­—ç¬¦çš„è½¬æ¢ï¼š

ä½¿ç”¨ ``char=?`` å¯ä»¥æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ï¼Œæˆ–è€… ``char-ci=?`` å¿½ç•¥å¤§å°å†™ï¼š

```racket
(char=? #\a #\a)
(char-ci=? #\a #\A)
(char=? #\a #\u61)
(char=? #\ã€ #\ã€)
```

*å­—ç¬¦ä¸²* æ˜¯å›ºå®šé•¿åº¦çš„å­—ç¬¦æ•°ç»„ï¼Œä½¿ç”¨åŒå¼•å·åŒ…èµ·æ¥ã€‚

```racket
(display "\u03BB\u03BB\n\u03BB")
```

å­—ç¬¦ä¸²åˆ†ä¸ºâ€œå¯å˜â€å’Œâ€œä¸å¯å˜â€ä¸¤ç§æƒ…å†µã€‚ç›´æ¥å†™æ­»çš„æ˜¯ä¸å¯å˜çš„å­—ç¬¦ä¸²ï¼Œé€šè¿‡ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥å¾—åˆ°å¯å˜çš„å­—ç¬¦ä¸²ï¼š

```racket
#lang racket  

(define s (make-string 10 #\.))
(display s)
(display "\n")
(string-set! s 2 #\x)
(display s)
```


## å­—èŠ‚å’Œå­—èŠ‚ä¸² ##

*racket* çš„ *å­—èŠ‚*ï¼Œå°±æ˜¯ *0-255* çš„æ•´æ•°ï¼š

```racket
(byte? 0) ;#t
(byte? 256) ;#f
```

*å­—èŠ‚ä¸²* æ˜¯ä½¿ç”¨ *#* å‰ç¼€çš„å­—ç¬¦ä¸²æ ·å­ï¼š

```racket
#"Hello"
"Hello"

(define b (make-bytes 10 0))
(bytes-set! b 0 97)
b
```

å¦‚æœä½¿ç”¨ ``display`` å‡½æ•°å»è¾“å‡ºå­—èŠ‚ä¸²çš„è¯ï¼Œå®ƒä¼šæŒ‰ UTF-8 çš„ç¼–ç æ–¹å¼å¤„ç†ã€‚

å­—èŠ‚ä¸²å’Œå­—ç¬¦ä¸²çš„ç›¸äº’è½¬æ¢ï¼Œéœ€è¦ä½¿ç”¨ä¸“é—¨çš„å‡½æ•°å®ç°ï¼š

```racket
(bytes->string/utf-8 #"\xCE\xBB") ;Î»
```

## ç¬¦å· ##

ç¬¦å· *Symbol* æ˜¯å…ƒç¼–ç¨‹ä¸­éå¸¸åŸºç¡€çš„æ¦‚å¿µï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š

```racket
(first '(define a 1))
(first '("define" a 1))
```

å®ƒä»¬è¿”å›çš„æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ

ç¬¬ä¸€è¡Œä»£ç ï¼Œè¿”å›çš„å°±æ˜¯ ``define`` ç¬¦å·ï¼š

```racket
(eq? [first '(define a 1)] 'define)
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ ``gensym`` å‡½æ•°ï¼Œæ¥è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç³»ç»Ÿå”¯ä¸€çš„ç¬¦å·ï¼Œè¿™åœ¨ä¸€äº›å®å±•å¼€çš„å®ç°ä¸­ï¼Œæ˜¯å¿…é¡»çš„ï¼š

```racket
(define s (gensym))
```

``string->uninterned-symbo`` å‡½æ•°ï¼Œå¯ä»¥æŠŠä¸€ä¸ªå­—ç¬¦ä¸²è½¬æˆå”¯ä¸€ç¬¦å·ï¼š

```racket
(eq? [string->uninterned-symbol "a"] [string->uninterned-symbol "a"]) ;#f
```

## å…³é”®è¯ ##

*å…³é”®è¯*ï¼Œ *Keyword* ï¼Œæ˜¯ *racket* ä¸­æ–°çš„æ¦‚å¿µï¼Œæ„Ÿè§‰è·Ÿå…¶å®ƒç¼–ç¨‹è¯­è¨€ä¸­çš„â€œå…³é”®è¯å‚æ•°â€æ˜¯ä¸€æ ·çš„ï¼Œå…·ä½“çš„ä½œç”¨ï¼Œä¹Ÿæ˜¯é™¤äº†å‡½æ•°å‚æ•°ä¸­çš„â€œå…³é”®è¯å‚æ•°â€ï¼Œæˆ‘è¿˜ä¸çŸ¥é“èƒ½åšä»€ä¹ˆã€‚

å½¢å¼ä¸Šï¼Œä¸ *Symbol* ç±»ä¼¼ï¼Œæ¯”å¦‚ ``#:hello`` ï¼Œä½†æ˜¯å®ƒä»¬æ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹ï¼š

```racket
(symbol? '#:app)
(keyword? '#:app)
```

ä½¿ç”¨ä¸Šï¼Œæ”¾åœ¨å‚æ•°å‰é¢å°±å¯ä»¥äº†ï¼š

```racket
#lang racket  

(define (lst a b #:a ka #:b kb) (list a b ka kb))
(lst 1 2 #:a 3 #:b 4)
(lst #:b 3 1 2 #:a 1)
```

æœ‰äº† *keyword* æœºåˆ¶ï¼Œå¯ä»¥åœ¨ä¼ å‚æ—¶ï¼Œé¡ºåºä¸Šæ²¡æœ‰é™åˆ¶ã€‚é *keyword* å‚æ•°ï¼Œå†æŒ‰é¡ºåºåŒ¹é…ã€‚


## åˆ—è¡¨å’Œç»“å¯¹ ##

è¿™ä¸ªå‰é¢å·²ç»ä½¿ç”¨è¿‡å¾ˆå¤šäº†ã€‚


```racket
#lang racket  

(cons 1 2)
(cons 1 '(2))
(cons 1 null)
(cons 1 empty)

(display "-----\n")

(empty? null)
(null? empty)

(display "-----\n")

(list? '(1 . 2))
(list? '(1 2))

(display "-----\n")

(pair? '(1 2))
(pair? '(1 . 2))
```

å¯ä»¥çœ‹å‡ºï¼Œ *list* æ˜¯ *pair* çš„ç‰¹æ®Šæƒ…å†µã€‚


## å‘é‡ ##

*å‘é‡*ï¼Œ *Vector* ï¼Œæ˜¯ *racket* é¢„ç½®çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚å¦‚æœè¯´ *list* æ˜¯é“¾è¡¨ï¼Œé‚£ *vector* å°±åƒä¼ ç»Ÿå®šé•¿æ•°ç»„äº†ï¼Œå®ƒå¯ä»¥åœ¨ ``O(1)`` æ—¶é—´è®¿é—®æŒ‡å®šæˆå‘˜ã€‚

åŒæ—¶ï¼Œè·Ÿ *strings* ä¸€æ ·ï¼Œ *vector* ä¹Ÿåˆ†å¯å˜çš„ï¼Œæˆ–è€…ä¸å¯å˜çš„ã€‚

å½¢å¼ä¸Šï¼Œå¯ä»¥çœ‹æˆåŠ äº† ``#`` å‰ç¼€çš„åˆ—è¡¨ï¼Œæˆ–è€…æ˜¯åŠ äº† ``#19`` è¿™ç§å‰ç¼€çš„åˆ—è¡¨ï¼Œ ``#`` åé¢å¯ä»¥æœ‰ä¸€ä¸ªå¯é€‰çš„é•¿åº¦ã€‚

å¦‚æœæŒ‡å®šäº†é•¿åº¦ï¼Œåˆ™ä¼šä½¿ç”¨æœ€åä¸€ä¸ªæˆå‘˜å¡«å……åˆ°æŒ‡å®šé•¿åº¦ã€‚


```racket
#(1 2 x3 display)
#8(1 2 x3 display)

(vector 1 2 3 'define)
(vector-ref #(1 2 3 define) 3)
```

## ä¸‰ç§ä¸åŒçš„â€œç­‰äºâ€ ##

ä¸‹é¢ä»‹ç»çš„â€œå“ˆå¸Œè¡¨â€ï¼Œæ¶‰åŠä¸‰ç§ä¸åŒçš„ *key* çš„åŒ¹é…æ–¹å¼ï¼Œåˆ†åˆ«å¯¹äºä¸‰ç§æ¯”è¾ƒå‡½æ•°ï¼š

- ``equal?``
- ``eqv?``
- ``eq?``


``eq?`` ç®—æ˜¯æœ€ä¸¥æ ¼çš„ï¼Œå®ƒéœ€è¦ä¸¤è€…æ˜¯ç›¸åŒçš„å¯¹è±¡ï¼š

```racket
(eq? 1 1)
(eq? 1.0 1.0)
(eq? 1.0 1) ;#f
(eq? (expt 2 10) (expt 2 10))
(eq? (expt 2 10) 1024)
(eq? (expt 2 100) (expt 2 100)) ;#f
(eq? (cons 1 2) (cons 1 2)) ;#f
(eq? 1/2 2/4)
(eq? "hello" "hello")
(eq? "hello" (bytes->string/utf-8 #"hello")) ;#f
```

è¿™é‡Œæ³¨æ„ï¼Œå¤§æ•´æ•° ``(expt 2 100)`` å¯èƒ½æ˜¯ä¸åŒå¯¹è±¡ã€‚

``eqv?`` ï¼Œæ˜¯åœ¨ ``eq?`` åŸºç¡€ä¸Šï¼Œæœ‰ä¸€äº›â€œæ”¾å®½â€ï¼Œåœ¨æ•°å­—ï¼š

```racket
(eq? (expt 2 100) (expt 2 100)) ;#f
(eqv? (expt 2 100) (expt 2 100)) ;#t
```

``equal?`` æ˜¯æœ€å¸¸ç”¨çš„åˆ¤æ–­ï¼Œå®ƒæ˜¯æ™®éæ„ä¹‰ä¸Šçš„â€œå€¼â€çš„æ¯”è¾ƒï¼ˆ ``eq?`` å’Œ ``eqv?`` çš„ ``true`` è‚¯å®šä¹Ÿæ˜¯ ``equal?`` çš„ ``true``ï¼‰ï¼š

```racket
(equal? 1.0 1) ;#f
(equal? (expt 2 100) (expt 2 100)) ;#t
(equal? (cons 1 2) (cons 1 2)) ;#t
(equal? "hello" (bytes->string/utf-8 #"hello")) ;#t
(equal? '(1 2 3) '(1 2 3)) ;#t
```


## å“ˆå¸Œè¡¨ ##

*Hash Table* ä¹Ÿæ˜¯ä¸€ç§ *racket* å†…ç½®çš„æ•°æ®ç»“æ„å®ç°ã€‚å®ƒå¯ä»¥åˆ†ä¸ºå¯å˜å’Œä¸å¯å˜çš„ä¸¤å¥—ï¼Œå¯¹äºä¸å¯å˜çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥â€œæ‰©å±•å®ƒæ„å»ºæ–°çš„ç»“æ„â€ã€‚åŒæ—¶ï¼Œæ ¹æ® *key* çš„æ¯”è¾ƒè§„åˆ™ä¸åŒï¼Œåˆè¿›ä¸€æ­¥åˆ†æˆä¸‰ç§å­ç±»ï¼Œåˆ†åˆ«ä½¿ç”¨ ``equal?`` ``eqv?`` ``eq?`` ä½œä¸º *key* çš„æ¯”è¾ƒã€‚

æ„å»ºå¯å˜çš„ *Hash Table* ï¼Œå¯ä»¥ä½¿ç”¨ ``make-hash`` ``make-hasheqv`` ``make-hasheq`` å‡½æ•°ï¼Œæ„å»ºä¸å¯å˜çš„ç»“æ„ï¼Œå‡½æ•°å°±åˆ†åˆ«æ˜¯ ``hash`` ``hasheqv`` ``hasheq`` ã€‚

å¯å˜çš„ç»“æ„ï¼š

```racket
#lang racket  

(define ht (make-hash))
(hash-set! ht "first" 1)
(hash-set! ht 'second '(1 2 hello))
(hash-set! ht 3 'world)

(hash-ref ht 'second)
(hash-ref ht 3)
(hash-ref ht "first")
```

ä¸å¯å˜çš„ç»“æ„ï¼Œé™¤äº† ``hash`` å‡½æ•°ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ ``#hash`` è¯­æ³•ï¼š

```racket
(define ht [hash "first" 1 'second "two" 3 'third])
(hash-ref ht 3)
; error
; (hash-set! ht "first" 2)

(define ht #hash(["first" . 1] [second . "two"] [3 . 'third]))
(hash-ref ht 'second)
```

``#hash`` æ„Ÿè§‰æ˜¯ä¸€ä¸ªå®ï¼Œé‡Œé¢ä¸èƒ½å†ä½¿ç”¨ *symbol* ï¼Œç›´æ¥å†™çš„æ ‡è¯†å°±æ˜¯ *symbol* ï¼Œå–å€¼æ—¶è¦æ³¨æ„ã€‚

å¯¹äº *Hash Table* ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ ``hash-set`` æ–¹æ³•å¾—åˆ°ä¸€ä¸ªæ–°å¯¹è±¡ï¼š

```racket
(define ht [hash "first" 1 'second "two" 3 'third])
(hash-ref ht 3)

(define new_ht (hash-set ht "four" 444))
(hash-ref new_ht "four")
(hash-ref new_ht "first")
```



## å°ç®± ##

*å°ç®±* è¿™ä¸ªåå­—æ˜¯æˆ‘è‡ªå·±è¯‘çš„ï¼ŒæŒ‡çš„å°±æ˜¯ *Box* è¿™ç§æ•°æ®ç±»å‹ã€‚

å®ƒåˆçœ‹å¥½åƒæ²¡å•¥ç”¨ï¼Œæˆ‘ä¸ªäººç›®å‰çš„çœ‹æ³•ï¼Œæ˜¯å®ƒæä¾›äº†ä¸€ç§ç›´æ¥çš„â€œå¼•ç”¨â€çš„è¡¨è¾¾èƒ½åŠ›ï¼Œåƒâ€œæŒ‡é’ˆâ€ã€‚åŒæ—¶ï¼Œç½‘ä¸Šæœ‰äººæï¼Œ *Box* å¯èƒ½å¯¹äºåº”ç”¨å¼€å‘åœºæ™¯æ¥è¯´ä¸é‡è¦ï¼Œä½†æ˜¯å¯¹äºâ€œè¯­è¨€å¼€å‘â€åœºæ™¯ï¼Œå®ƒæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

*Box* çš„å€¼æ‰“å°å‡ºæ¥æ—¶ï¼Œä¼šæ˜¯åƒ ``'#&2`` è¿™ç§ï¼Œä»¥ ``#&`` å¼€å¤´ã€‚

```
#lang racket  


(define p (box 1))
(define (add1 p1) (set-box! p (+ (unbox p) 1)))
(add1 p)
p

(define r 1)
(define (add2 v) (set! v (+ v 2)))
(add2 r)
r
```

ä»å¦ä¸€ä¸ªæ–¹é¢æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°éœ€è¦ä½ ä¼ å…¥ *Box* ï¼Œé‚£ä¹ˆä¹Ÿå°±å¯ä»¥è¡¨ç¤ºï¼Œè¿™ä¸ªå‡½æ•°ä¼šç›´æ¥æ›´æ”¹å®ƒï¼Œè€Œä¸æ˜¯è¿”å›ä¸€ä¸ªæ–°å€¼ã€‚


## Void å’Œ Undefined ##

è¿™æ˜¯ä¸¤ä¸ªç‰¹æ®Šçš„å€¼ï¼Œ ``(void)`` æ–¹æ³•ï¼Œå¯ä»¥å¾—åˆ° ``#<void>`` ç±»å‹çš„è¿”å›ï¼Œå®ƒè¡¨ç¤ºâ€œæ— â€ï¼Œæ¯”å¦‚ ``display`` å‡½æ•°å°±æ˜¯æ²¡æœ‰è¿”å›çš„ã€‚

```racket
(void 1 2 3)
```

``#<undefined>`` ï¼Œå¯ä»¥åœ¨ä¸€äº›æœªåˆå§‹åŒ–å€¼çš„è®¿é—®æ—¶å‡ºç°ï¼ˆä¹Ÿå¯èƒ½æŠ¥é”™ï¼‰ã€‚


# å…¶å®ƒè¡¨è¾¾å¼ç»†èŠ‚ #

## å‡½æ•°è°ƒç”¨å’Œå‚æ•° ##

### å‡½æ•°çš„ apply è°ƒç”¨ ###

``apply`` å¯ä»¥ç”¨äºâ€œå±•å¹³â€å‡½æ•°è°ƒç”¨å‚æ•°ï¼š

```racket
(+ 1 2 3)
(define (sum lst) (apply + lst))
(sum '(1 2 3))
```

åŸºæœ¬å¯ä»¥å¤šåŠ ä¸€ä¸ªå‚æ•°ï¼š

```racket
(apply - 0 '(1 2 3))
(- 0 1 2 3)
```

### å‡½æ•°çš„ä¸å®šå‚æ•° ###

å‚æ•°åˆ—è¡¨çš„æœ€åä¸€ä¸ªå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ *ç‚¹* åˆ†å‰²ï¼Œåˆ™æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè¡¨ç¤ºå‰©ä¸‹çš„ä¸å®šå‚æ•°ï¼š

```racket
(define (sum a b . c) (+ a b (apply + c)))
(sum 1 2 3 4 5 6 7 8 9 10)
```

### å‡½æ•°çš„é»˜è®¤å‚æ•° ###

å‚æ•°åˆ—è¡¨ä¸­ï¼Œä¸­æ‹¬å·æ‹¬èµ·æ¥çš„ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªé»˜è®¤å€¼ï¼š

```racket
(define (sum a [b 100] . c) (+ a b (apply + c)))
(sum 1)
```

### å‡½æ•°çš„å…³é”®è¯å‚æ•° ###

å…³é”®è¯å‚æ•°ï¼Œå¯ä»¥å’Œé»˜è®¤å‚æ•°æ··åˆä½¿ç”¨ï¼š

```racket
(define (sum a #:b [b 100] . c) (+ a b (apply + c)))
(sum #:b 10 1 2 3)
```

### å‡½æ•°çš„æ ¹æ®å‚æ•°åŒ¹é… ###

æ¨¡å¼åŒ¹é…è¿™ç§æ—¶é«¦çš„ä¸œè¥¿ï¼Œ*racket* è‡ªç„¶ä¸ä¼šé”™è¯¯ã€‚é€šè¿‡ ``case-lambda`` å¯ä»¥å®ç°æ ¹æ®å®é™…å‚æ•°ä¸ªæ•°ï¼Œè°ƒç”¨ä¸åŒçš„é€»è¾‘ï¼š

```racket
#lang racket  

(define something 
  (case-lambda
    [(a) (+ a 1)]
    [(a b) (* a b)]
    [(a b c) ((+ a b) . - . c)]
))

(something 1)
(something 2 10)
(something 2 10 30)
```

## å¤šå€¼è¿”å›å’Œå¤šå€¼å®šä¹‰ ##

è¿™é‡Œè¯´çš„â€œå¤šå€¼è¿”å›â€ï¼Œæ˜¯çœŸæ­£çš„å¤šå€¼è¿”å›ï¼Œä¸æ˜¯ç”¨åˆ—è¡¨æçš„â€œæ¨¡å¼åŒ¹é…â€ã€‚

ä½¿ç”¨ ``values`` å®Œæˆå¤šå€¼è¿”å›ï¼Œå¯¹åº”çš„ä½¿ç”¨ ``define-values`` å®Œæˆå¤šå€¼å®šä¹‰ï¼š

```racket
(define-values (a b) (values 1 2))
a
b
```

## å¤šç§æ•°æ®ç»‘å®šæ–¹å¼ ##

### let, let*, letrec ###

- ``let`` åªèƒ½åœ¨ ``body`` ä¸­å¯è§ã€‚
- ``let*`` åœ¨å…¶å®ƒ ``let`` ä¸­ä¹Ÿå¯è§ã€‚
- ``letrec`` è¡¨è¾¾å¼â€œæå‰â€å¯è§ï¼Œå¯ä»¥åœ¨é€’å½’ä¸­ä½¿ç”¨ã€‚


``let`` æ˜¯æœ€æ™®é€šçš„ï¼š

```racket
(let ([a 1]) (+ a 1))
```

``let*`` æ˜¯åœ¨å®šä¹‰è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å‰é¢çš„å€¼ï¼š

```racket
(let* ([a 1] [b (+ a 1)]) (+ a b))
```

``letrec`` æ˜¯å¯ä»¥â€œæå‰â€ä½¿ç”¨å°†è¦å®šä¹‰çš„å€¼ï¼Œå¯ä»¥ç”¨äºé€’å½’ï¼š

```racket
#lang racket  

(letrec
  ([last-of-lst
     (lambda (lst)
       (if [empty? (rest lst)]
         (first lst)
         (last-of-lst (rest lst))))])
  (last-of-lst '(1 2 3 4 5)))
```


### å‘½åç»‘å®š ###

ä½¿ç”¨ ``let`` æ—¶åœ¨åé¢è·Ÿä¸€ä¸ªåå­—ï¼Œç­‰äºå®šä¹‰äº†ä¸€ä¸ªè¿™ä¸ªåå­—çš„å‡½æ•°ï¼Œå¹¶ä¸”ç”¨ ``let`` çš„å€¼ä½œä¸ºå‚æ•°é©¬ä¸Šè°ƒç”¨ï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥ç”¨äºé€’å½’ï¼š

```racket
(let add ([a 4] [b 2])
  [if (= a 0) b (add (- a 1) (+ b b))])
```


### å¤šå€¼ç»‘å®š ###

å¤šå€¼ç»‘å®šæ˜¯ä¸ºäº†é…åˆâ€œå¤šå€¼è¿”å›â€çš„ä¸€å¥—å®ç°ï¼Œ ``let-values``, ``let*-values``, ``letrec-values`` ï¼š

```racket
(let-values (([a b c] [values 1 2 3])) [+ a b c])
```


## å¤šè¯­å¥åºåˆ— ##

å¦‚æœæ‰“ç®—åœ¨ä¸€ä¸ªè¡¨è¾¾å¼é‡Œé¢ï¼Œåšå¤šä»¶äº‹ï¼Œå¯ä»¥ä½¿ç”¨ ``begin`` æˆ–è€… ``begin0`` æŠŠè¿™ä¸ªè¡¨è¾¾å¼åŒ…èµ·æ¥ï¼Œå°±å¯ä»¥å†™å¤šä¸ªè¯­å¥äº†ã€‚

å®ƒä»¬ä¹‹å‰çš„ä¸åŒåœ¨äºï¼Œ ``begin`` è¿”å›æœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼Œè€Œ ``begin0`` è¿”å›ç¬¬ä¸€ä¸ªè¡¨è¾¾å¼çš„å¼ã€‚

```racket
(define (func a)
  (if (> a 1)
    [begin0
      a
      (display "a > 1\n")]
    [begin0
      0
      (display "a <= 1\n")]))

(func 1)
(func 2)
```

ä¸Šé¢çš„ä»£ç æ³¨æ„åŒºåˆ« ``display`` è¾“å‡ºçš„å†…å®¹ï¼Œä¸ ``(func 1)`` çš„è¿”å›å€¼ã€‚

``when`` å’Œ ``unless`` æ˜¯ç±»ä¼¼ ``if`` çš„åŠŸèƒ½ï¼Œä¸è¿‡å®ƒä»¬åé¢ç›´æ¥å¯ä»¥è·Ÿå¤šæ¡è¯­å¥ï¼Œè€Œä¸ç”¨ä¸“é—¨å†™ ``begin`` äº†ï¼š

```racket
(define (func a) (when [> a 1]
                   [display "1\n"]
                   [display "2\n"]
                   "OK"))
(func 1)
(func 2)
```

## å¼•ç”¨ä¸æ±‚å€¼ ##

```racket
(list 1 2 3)
'(1 2 3)
(quote (1 2 3))
```

ä¸Šé¢ä¸‰ä¸ªè¯­å¥çš„è¿”å›æ˜¯ä¸€æ ·çš„ã€‚ *lisp* ç³»åˆ—è¯­è¨€æœ€é£éªšçš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒçš„è¯­å¥å°±æ˜¯ *åˆ—è¡¨*ï¼Œæ‰€ä»¥ç´§æ¥ç€çš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä»€ä¹ˆæ—¶å€™åº”è¯¥å¯¹ä¸€ä¸ªåˆ—è¡¨ *æ±‚å€¼* ï¼Œä»€ä¹ˆæ—¶å€™å°±æŠŠå®ƒå½“æˆæ˜¯ä¸€ä¸ª *åˆ—è¡¨ç»“æ„* ã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£æˆï¼Œæ€»æ˜¯ä¼šæ±‚å€¼ï¼Œåªæ˜¯ï¼Œåƒ ``quote`` è¿™ä¸ªå‡½æ•°ï¼Œå®ƒæ±‚å€¼çš„ç»“æ„å°±æ˜¯å®ƒçš„å‚æ•°åˆ—è¡¨è€Œå·²ã€‚

åŒæ—¶ï¼Œåˆå› ä¸ºä½¿ç”¨â€œåˆ—è¡¨ç»“æ„â€æ˜¯å¦‚æ­¤æ™®éï¼Œæ‰€ä»¥é’ˆå¯¹ ``quote`` å‡½æ•°çš„è°ƒç”¨ï¼Œä¸“é—¨ç»™äº†å®ƒä¸€ä¸ªç‰¹æ®Šå½¢å¼ï¼Œå°±æ˜¯å†™æˆ ``'(1 2 3)`` è¿™ç§ï¼Œå®ƒå°±ç›¸å½“äº ``(quote (1 2 3))`` ã€‚

å¦å¤–ä¸€ä¸ª ``quasiquote`` ï¼Œä½œç”¨å’Œ ``quote`` æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å®ƒåœ¨ä¸æ±‚å€¼çš„åˆ—è¡¨å½“ä¸­ï¼Œå¯ä»¥æ··å…¥éƒ¨åˆ†çš„æ±‚å€¼ï¼š

```racket
(quasiquote (1 2 (unquote (+ 1 2))))
```

ä½¿ç”¨ ``unquote`` åŒ…èµ·æ¥çš„éƒ¨åˆ†ï¼Œåˆæ˜¯éœ€è¦æ±‚å€¼çš„ï¼Œæœ‰ç‚¹åƒä¸€ä¸ªæ¨¡æ¿ã€‚

å¦å¤–ä¸€ä¸ª ``unquote-splicing`` å’Œ ``unquote`` ç±»ä¼¼ï¼Œåªæ˜¯å®ƒåé¢çš„è¡¨è¾¾å¼éœ€è¦è¿”å›ä¸€ä¸ª *list* ï¼š

```racket
(quasiquote (1 2 (unquote-splicing '(1 2 3))))
```

è¿™ç§å¼•ç”¨ï¼Œæ±‚å€¼ï¼Œåå¼•ç”¨çš„å¤æ‚å…³ç³»ï¼Œå°±ä½¿å¾—æˆ‘ä»¬å†™çš„ä»£ç ï¼Œåˆ°åº•æ˜¯åœ¨æ±‚å€¼ï¼Œè¿˜æ˜¯åœ¨ç”Ÿæˆå¦å¤–ä¸€éƒ¨åˆ†ä»£ç ï¼Œä¹‹é—´çš„ç•Œé™å˜å¾—éå¸¸æ¨¡ç³Šäº†ã€‚

è€Œè¿™äº›å…ƒç¼–ç¨‹çš„åŸºç¡€ç»“æ„ï¼Œå…¶åœ°ä½ä¹‹æ˜¾èµ«ï¼Œéƒ½æœ‰ä¸“é—¨ç»“æ„ç‰¹æ®Šå¯¹å¾…çš„ï¼š

- ``'`` æ˜¯ ``quote``, ``'(1 2 3)``
- ````` æ˜¯ ``quasiquote`` , ```(1 2 3)``
- ``,`` æ˜¯ ``unquote`` , ```(1 2 ,(+ 1 2))``
- ``,@`` æ˜¯ ``unquote-splicing`` , ```(1 2 ,@(list 1 2))``


## åˆ†æ”¯åˆ¤æ–­ ##

å‰é¢ç”¨è¿‡äº† ``if`` ï¼Œæ›´ä¸€èˆ¬å½¢å¼çš„æ˜¯ ``cond`` ï¼š

```racket
#lang racket  

(define (func a)
  (cond ([= a 1] 10)
        ([= a 2] 100)
        ([= a 3] 1000)
        (else 10000)))

(func 1)
(func 3)
```

æ™®é€šæƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ ``case`` :

```racket
(define (func a)
  (case a
    [(1) 10]
    [(2) 100]
    [(3 4 5) 1000]
    [else 10000]))

(func 3)
(func 8)
```


## ä¸“ç”¨å‚æ•° ##

*ä¸“ç”¨å‚æ•°* è¿™ä¸ªåå­—æ˜¯æˆ‘è‡ªå·±å–çš„ï¼Œæ–‡æ¡£ä¸­æ˜¯ *parameterize* ã€‚

æˆ‘ä¸ªäººç†è§£ï¼Œè¿™ä¸ªæœºåˆ¶ï¼Œæ˜¯å¤„ç†â€œé…ç½®æ€§â€å†…å®¹çš„ç»ä½³é€‰æ‹©ï¼Œå®ƒèåˆäº†â€œå˜é‡â€ï¼Œâ€œä¸Šä¸‹æ–‡â€ï¼Œâ€œä½œç”¨åŸŸâ€ç­‰æ¦‚å¿µã€‚


ä½¿ç”¨æ–¹æ³•ä¸Šï¼Œå…ˆç”¨ ``define`` åŠ  ``make-parameter`` å®šä¹‰ä¸€ä¸ªåˆå§‹å€¼ï¼Œç„¶ååœ¨ä½¿ç”¨çš„åœ°æ–¹ï¼Œç”¨ ``parameterize`` â€œä¸´æ—¶èµ‹å€¼â€ã€‚

```racket
#lang racket  

(define times (make-parameter 10))
(define (func n) (* n (times)))

(func 10)

(parameterize ([times 2])
  [begin0
    (func (parameterize ([times 1]) (func 5)))
    (parameterize ([times 1000]) '())
    ])

(times)
```

- ä½¿ç”¨â€œè°ƒç”¨â€è·å–å‚æ•°å€¼ã€‚
- å‚æ•°çš„å€¼æ˜¯åœ¨ ``(parameterize)`` ç»“æ„ä¸­ï¼Œè¢«å±‚å±‚é™åˆ¶ä½œç”¨åŸŸçš„ã€‚
- ç¦»å¼€ ``(parameterize)`` ä¹‹åï¼Œå‚æ•°å€¼ä¼šè‡ªåŠ¨â€œè¿˜åŸâ€ã€‚



# è‡ªå®šä¹‰ç»“æ„ #

## åŸºæœ¬ç”¨æ³• ##

ä½¿ç”¨ ``struct`` å¯ä»¥è‡ªå®šä¹‰ä¸€ç§ç»“æ„ï¼š

```racket
(struct point (x y))
(define p (point 1 2))
```

å®šä¹‰ä¹‹åï¼Œç»“æ„çš„åå­—ï¼Œå°±æ˜¯è¿™ä¸ªç»“æ„â€œå®ä¾‹åŒ–â€çš„å‡½æ•°åã€‚åŒæ—¶ï¼Œä¼šå­˜åœ¨ä¸€ç³»åˆ—ä¸ç»“æ„åç›¸å…³çš„å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥å¤„ç†ç»“æ„çš„å®ä¾‹ï¼š

```racket
(point? p)
(point-x p)
```

ç»“æ„å¯ä»¥è¢«æ‰©å±•ï¼Œæˆ–è€…è¯´ï¼Œå¯ä»¥ç»§ç»­å®šä¹‰å­ç»“æ„ï¼š


```racket
(struct point (x y))
(struct point-3d point (z))
(define p (point-3d 1 2 3))
(point? p)
(point-3d? p)
(point-3d-z p)
;(point-3d-x p)
(point-x p)
```

``point-3d`` æ˜¯ ``point`` çš„å­ç»“æ„ï¼Œæ‰€ä»¥ ``p`` åœ¨ ``point?`` å’Œ ``point-3d?`` çš„ç»“æœéƒ½ä¼šæ˜¯ ``#t`` ã€‚

ä½†æ˜¯åœ¨è·å–å±æ€§å€¼çš„æ—¶å€™ï¼Œå­ç»“æ„åªèƒ½è·å–è‡ªå·±çš„é‚£éƒ¨åˆ†ï¼Œå¦åˆ™å°±éœ€è¦ä½¿ç”¨çˆ¶ç»“æ„çš„æ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢ä»£ç ä¸­çš„ ``(point-3d-x p)`` å°±ä¼šæŠ¥é”™ã€‚

ç»“æ„ä¹Ÿå¯ä»¥å¤åˆ¶æ›´æ–°ï¼š

```racket
(struct point (x y))
(define p (point 1 2))
(define p2 (struct-copy point p (y 10)))
(point-x p2)
(point-y p2) ;10
```

## é€æ˜ç»“æ„å’Œè™šæ‹Ÿç»“æ„ ##

å‰é¢ä»‹ç»çš„ ``struct`` æ™®é€šç”¨æ³•ï¼Œå¯ä»¥æ­£å¸¸å¾—åˆ°ä¸€ä¸ªç»“æ„å®ä¾‹ã€‚ä½†æ˜¯è¿™ä¸ªå®ä¾‹åœ¨åç»§çš„ä½¿ç”¨ä¸­ï¼Œæ— æ³•å†è¢«äº†è§£åˆ°æ„é€ æ—¶çš„æƒ…å†µï¼Œæˆ‘ä»¬æŠŠå®ä¾‹æ‰“å°å‡ºæ¥ï¼Œçœ‹åˆ°çš„ä¹Ÿåªæ˜¯ç±»å‹ ``#<point>`` è¿™æ ·çš„ä¿¡æ¯ï¼Œä¸çŸ¥é“åœ¨æ„é€ æ—¶çš„å‚æ•°æ˜¯ä»€ä¹ˆã€‚å®ƒè‡ªç„¶æ˜¯æœ‰åˆ©äºâ€œå°è£…â€çš„è¡Œä¸ºï¼Œä¸è¿‡æœ‰æ—¶åœ¨æˆ‘ä»¬éœ€è¦ *public* è¡Œä¸ºæ—¶ï¼Œå°±ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„äº†ã€‚

å¯¹æ­¤ï¼Œ *racket* è¿˜æœ‰ä¸¤ç§ç±»å‹çš„æ‰©å±•æœºåˆ¶ã€‚ *é€æ˜ç±»å‹ transparent* å’Œ *è™šæ‹Ÿç±»å‹ previously fabricated* ã€‚å‰è€…æ˜¯è§£å†³ *public* çš„ä¸€ç§è‡ªç„¶æƒ³æ³•ï¼Œåè€…å°±æœ‰ç‚¹å¤©é©¬è¡Œç©ºçš„æ„Ÿè§‰äº†ã€‚


```racket
(struct point (x y))

(define (get-point x y) 
    (struct point (x y) #:transparent)
    (point x y)
  )
(get-point 1 2)
```

å½“åœ¨ ``struct`` åé¢æ·»åŠ  ``#:transparent`` å…³é”®å­—åï¼Œè¿™ä¸ªç»“æ„å°±æ˜¯â€œé€æ˜ç±»å‹â€äº†ã€‚å¯¹äºé€æ˜ç±»å‹ï¼Œç°åœ¨èƒ½çœ‹åˆ°çš„åªæ˜¯æ‰“å°å‡ºæ¥çš„æ ·å­ï¼Œä» ``#<point>`` å˜æˆäº† ``(point 1 2)`` ï¼Œè‡³å°‘èƒ½çœ‹åˆ°æ„é€ æ—¶çš„å‚æ•°äº†ã€‚åé¢ï¼Œè¿˜æœ‰åå°„ç›¸å…³çš„æœºåˆ¶å¯ä»¥ä½œç”¨äºå®ƒã€‚

é’ˆå¯¹ä¸Šé¢çš„ä»£ç ï¼Œè¿˜å¯ä»¥äº†è§£åˆ°ï¼Œ ``struct`` å®šä¹‰ç»“æ„ï¼Œå¹¶ä¸æ˜¯å…¨å±€ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªè‡ªç„¶çš„ä½œç”¨åŸŸèŒƒå›´ï¼Œå¯ä»¥åœ¨å±€éƒ¨å†å®šä¹‰åŒåçš„ç»“æ„ã€‚

é™¤äº†â€œé€æ˜ç±»å‹â€ï¼Œè¿˜æœ‰ä¸€ä¸ª *è™šæ‹Ÿç±»å‹ previously fabricated* ï¼Œè¿™ä¸ªæœºåˆ¶ï¼Œç”šè‡³å¯ä»¥è®©æˆ‘ä»¬åœ¨ç»“æ„è¢«å®šä¹‰å‰ï¼Œå°±é¢„å…ˆå¼€å§‹ä½¿ç”¨è¿™ä¸ªç»“æ„äº†ï¼š

```racket
(define p #s(point 1 2))
```

è¿™ä¸ªåƒæ˜¯ä½¿ç”¨å‘é‡çš„è¯­å¥ï¼Œæ˜¯åˆæ³•çš„ã€‚å®ƒå®šä¹‰äº† ``p`` æ˜¯ä¸€ä¸ªåä¸º ``point`` çš„ç»“æ„çš„å®ä¾‹ã€‚ä½†æ˜¯è¿™ä¸ª ``point`` åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿç›®å‰ä¸ºæ­¢ï¼Œè¿™ä¸ª ``point`` ç¡®å®è¿˜ä¸å­˜åœ¨ã€‚

```racket
(define p #s(point 1 2))
(struct point (x y) #:prefab)
(point? p)
(point-x p)
```

å¯ä»¥åœ¨åé¢ä½¿ç”¨ ``struct`` å†åŠ ä¸Š ``#:prefab`` å†å®šä¹‰è¿™ä¸ªç»“æ„çš„å…·ä½“å½¢å¼ã€‚

å®ƒç›¸å¯¹äºå…¶å®ƒè¯­è¨€çš„ç¥å¥‡ä¹‹å¤„ï¼Œå°±æ˜¯å¯ä»¥æ‰‹å†™ ``#s(xxx 1 2)`` è¿™æ ·çš„è¿˜æ²¡æœ‰è¢«å®šä¹‰ä¸œè¥¿ï¼Œåœ¨è¯­æ³•ä¸Šæ˜¯åˆæ³•çš„ã€‚ *racket* / *scheme* è¿™æ ·çš„è¯­è¨€ï¼ŒçœŸæ˜¯æ— æ—¶ä¸åˆ»åœ¨å‘æˆ‘ä»¬ç¤ºæ„â€œå½¢å¼â€ä¸â€œé€»è¾‘â€ä¹‹é—´é‚£æ— æ‰€è°“èˆ¬å­˜åœ¨çš„ç•Œé™ã€‚



## æ›´å¤šçš„å‚æ•° ##

ç»“æ„å®šä¹‰ä¸­ï¼Œè¿˜å¯ä»¥åœ¨æœ«å°¾åŠ å…¥æ›´å¤šçš„å‚æ•°ã€‚è¿™äº›å‚æ•°ï¼Œä¸€éƒ¨åˆ†æ˜¯å±æ€§å®šä¹‰ï¼Œæ¯”å¦‚åƒ ``#:mutable`` ï¼Œå¦ä¸€éƒ¨åˆ†åƒæ˜¯ Python ä¸­çš„ç‰¹æ®Šæ–¹æ³•ï¼Œå¦‚ ``__str__`` ï¼Œå®šä¹‰äº†ä¸€ä¸ªç»“æ„çš„è¡Œä¸ºè¡¨ç°ï¼Œå¦‚ ``custom-write`` ã€‚

``#:mutable`` ï¼Œç»“æ„çš„å±æ€§å¯å˜ ï¼š

```racket
(struct point (x y) #:mutable)
(define p (point 1 2))
(point-x p)
(set-point-x! p 10)
(point-x p)
```

``#:auto-value`` ï¼Œå®šä¹‰ä¸€ä¸ªè‡ªåŠ¨å€¼ï¼ˆä¸å…è®¸ä¼ å‚ï¼Œä½†æ˜¯å¯ä»¥è·å–å±æ€§å€¼ï¼‰ï¼š

```racket
(struct o ([x #:auto]) #:auto-value 1)
(struct point o ([y #:auto]) #:auto-value 2)
(define p (point))
(o-x p)
(point-y p)
```

èƒ½è¿‡å±‚å±‚åµŒå¥—ï¼Œæœ€ç»ˆå¯ä»¥å¾—åˆ°ä¸€ä¸ª 0 å‚æ•°å€¼çš„ç»“æ„ã€‚


``#:guard`` å‚æ•°é¢„å¤„ç†ï¼Œå­ç±»å‹ä¹Ÿä¼šè§¦å‘çˆ¶çº§ï¼Œä½†æ˜¯åªä¼šä¼ é€’æœ‰é™å‚æ•°ï¼š

```racket
(struct point (x y)
  #:transparent
  #:guard [lambda (x y type-name)
            (if (= x 0) (values x y)
              (values (* 2 x) (* 2 y)))])

(point 1 2)
(point 0 2)
```

åœ¨è¿™é‡Œï¼Œä¹Ÿå¯ä»¥å¯¹å‚æ•°ä½œæœ‰æ•ˆæ€§çš„åˆ¤æ–­ï¼Œè¿”å›é”™è¯¯ï¼Œ ``(error type-name "wrong")`` ã€‚


``#:methods`` ï¼Œä¸€äº›é€šç”¨æ¥å£ï¼Œåƒ Python çš„ç‰¹æ®Šæ–¹æ³•ï¼Œç±»ä¼¼æœ‰ ``__getitem__``  ä¹‹ç±»çš„ã€‚è¿™é‡Œåªæ¼”ç¤ºä¸€ä¸‹ ``custom-write`` ï¼š

```racket
(define (print-out ins port mode)
  [display port]
  [display mode]
  [display "hello"]
  [display "\n"]
)

(struct point (x y)
  #:methods
  gen:custom-write
  [(define write-proc print-out)]
)

(define p (point 1 2))
p
```

``gen:custom-write`` çš„æ¥å£ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡ï¼Œä¸€æ¬¡æ˜¯ *nowhere* ï¼Œä¸çŸ¥é“è¿™æ ·è®¾è®¡çš„åˆè¡·ã€‚


``#:property`` ï¼Œå’Œ ``#:methods`` ä¸€æ ·çš„ï¼Œæ¯”å¦‚ ``prop:procedure`` æ˜¯å®šä¹‰åƒ Python ä¸­çš„ ``__call__`` è¡Œä¸ºï¼Œå³å®ä¾‹å¯ä»¥å†æ¬¡è¢«â€œè°ƒç”¨â€ã€‚ ``#:property`` å’Œ ``#:methods`` çš„åŒºåˆ«ï¼Œæ„Ÿè§‰åè€…æ˜¯ä¸€ä¸ªæ¥å£èŒƒå›´ï¼Œåƒå‰é¢çš„ï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ª ``write-proc`` æ–¹æ³•ã€‚è€Œ ``#:property`` é‡Œå°±ç›´æ¥æ˜¯å…·ä½“çš„è¡Œä¸ºäº†ï¼Œåƒ ``prop:procedure`` ç›´æ¥ä¸€ä¸ªå‡½æ•°å°±è¡Œã€‚

```racket
(struct point (x y)
  #:property
  prop:procedure
  (lambda (self a b) (+ (point-x self) (point-y self) a b))
)

(define p (point 1 2))
(p 10 20)
```

``#:super`` ï¼Œè·Ÿå‰é¢çš„ ``æ‰©å±•`` æ˜¯ä¸€æ ·çš„èƒ½åŠ›ï¼Œæ¢äº†ä¸ªå†™æ³•ï¼š

```racket
(struct point (x y))
(struct point-3d (z) #:super struct:point)

(define p (point-3d 1 2 3))
(point-3d-x p)
```

è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ï¼Œ ``point`` å’Œ ``struct: point`` æ˜¯ä¸åŒçš„ä¸œè¥¿ã€‚ ``struct?`` å’Œ ``struct-type?`` ä¹Ÿæ˜¯ä¸åŒçš„ã€‚


# æ¨¡å— #

## åŸºæœ¬ç”¨æ³• ##

*racket* çš„æ¨¡å—æœºåˆ¶ï¼Œæœ¬èº«è¿˜æ˜¯æ¯”è¾ƒç›´è§‚çš„ï¼Œä½†æ˜¯ç»†èŠ‚çš„å˜åŒ–ä¸Šï¼Œåˆæå¾—å¾ˆå¤æ‚ã€‚å…‰æ˜¯ ``require`` çš„å½¢å¼ï¼Œå°±æœ‰ä¸‰ç§ï¼š

```racket
(require demo) ;ä»åŒ…ç®¡ç†ä¸­å¯¼å…¥
(require "demo.rkt") ;ä»ç›¸å¯¹è·¯å¾„ä¸­å¯¼å…¥
(require 'demo) ;å¯¼å…¥å½“å‰çš„ä¸€ä¸ª module å®šä¹‰
```

æ¨¡å—çš„ç»“æ„ï¼ŒåŸºæœ¬æ˜¯æŒ‰ç›®å½•ç»“æ„ï¼Œæ–‡ä»¶ä¸­è¦â€œå¯¼å‡ºâ€çš„æ–¹æ³•ï¼Œéœ€è¦é¢å¤–çš„ä½¿ç”¨ ``provide`` ï¼Œå‡è®¾æœ‰ä¸€ä¸ª ``demo.rkt`` æ˜¯ä¸‹é¢çš„å†…å®¹ï¼š

```racket
#lang racket  


(provide get-point point-x)

(struct point (x y) #:transparent)
(define (get-point x y) (point x y))

(module* main #f
  (get-point 1 2))
```

æœ€åçš„ ``module* main #f`` ç›¸å…³äº Python ä¸­çš„ ``if __name__ == '__main__'`` ã€‚ ``provide`` å¯¼å‡ºä¸­ï¼Œéœ€è¦åŒ…æ‹¬ç›¸å…³çš„å‡½æ•°ï¼Œå¦åˆ™ï¼Œ ``get-point`` å‡ºå»çš„ç»“æ„ï¼Œä¹Ÿæ²¡åŠæ³•è·å–ç›¸å…³æ•°æ®çš„ã€‚

åœ¨å¦ä¸€ä¸ª ``a.rkwt`` å½“ä¸­å¯¼å…¥ ``demo.rkt`` ï¼š

```racket
#lang racket

(require "demo.rkt")
(define p (get-point 1 2))
(point-x p)
#;(point-y p)
```

æ¨¡å—æœ¬èº«ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„ç»“æœï¼Œå’Œæ–‡ä»¶æ²¡æœ‰å…³ç³»ã€‚æ–‡ä»¶ä¸Šçš„è¡¨ç°ï¼Œå·²ç»æ˜¯ä¸€ä¸ªåŠ å·¥äº†ã€‚

```racket
#lang racket  

(module demo (lib "racket/main.rkt")
  (display "in demo\n")
  (define (hello a) (display (string-join (list "Hello" a "\n"))))
  (provide hello))

(require 'demo)
(hello "world")
```

``lib`` å‡½æ•°åé¢è·Ÿå­—ç¬¦ä¸² ``"racket/main.rkt"``ï¼Œå°±ç›¸å…³äºç›´æ¥å†™ ``racket`` äº†ï¼Œè¡¨ç¤ºæ¨¡å—çš„ä½ç½®ã€‚è€Œè¿™é‡Œçš„ ``racket`` ï¼Œä¹Ÿå³ç›¸å½“äºä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒæŠŠå½“å‰æ–‡ä»¶ä½œä¸ºä¸€ä¸ª ``module`` å¿«æ·å®šä¹‰ï¼Œæœ€å¼€å¤´å†™çš„ ``#lang`` ï¼Œå°±æ˜¯ ``module`` å®Œæ•´å½¢å¼çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚



## æ¨¡å—ç›¸å…³è·¯å¾„ ##

é™¤äº†å½“å‰ä½ç½®çš„â€œç›¸å¯¹è·¯å¾„â€ï¼Œ *racket* ä¹Ÿæœ‰åŒ…å¯»æ‰¾è·¯å¾„å’Œå¯¹åº”çš„ç¯å¢ƒå˜é‡ã€‚

ç¯å¢ƒå˜é‡æ˜¯ *PLTCOLLECTS* ï¼Œå¯ä»¥æŒ‡å®šåŒ…å¯»æ‰¾çš„ä½ç½®ã€‚

é»˜è®¤çš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•æ‰¾åˆ°ï¼š

```racket
(require setup/dirs)
(find-user-collects-dir)
(get-collects-search-dirs)
```


## å­æ¨¡å— ##

æ¨¡å—å½“ä¸­å†é€šè¿‡ ``module`` æˆ–è€… ``module*`` ï¼Œå£°æ˜çš„æ¨¡å—ï¼Œå°±æ˜¯å­æ¨¡å—ã€‚ *racket* ä¸­çš„å­æ¨¡å—å…·æœ‰å’Œæ™®é€šæ¨¡å—ä¸€æ ·çš„ç‹¬ç«‹æ€§ï¼Œå³ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œéƒ½ä¸ä¼šéšçˆ¶æ¨¡å—å¯¼å…¥å¯¼å‡ºï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ª ``demo.rkt`` æ–‡ä»¶ï¼š

```racket
#lang racket  

(module demo (lib "racket/main.rkt")
  (display "in demo\n")
  (define (hello a) (display (string-join (list "Hello" a "\n"))))
  (provide hello))
```

åœ¨åŒç›®å½•çš„å¦ä¸€ä¸ª ``a.rkt`` æ–‡ä»¶ä¸­ï¼Œå¦‚æœå†™æˆï¼š

```racket
#lang racket

(require "demo.rkt")
(hello "world")
```

æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸º ``demo.rkt`` è¿™ä¸ªæ¨¡å—ï¼Œå¹¶æ²¡æœ‰ ``hello`` å‡½æ•°ï¼Œ ``hello`` æ˜¯åœ¨ ``demo.rkwt`` é‡Œé¢çš„å­æ¨¡å— ``demo`` é‡Œçš„ï¼Œè¦æ­£ç¡®å¼•å…¥ï¼Œéœ€è¦å†™æˆï¼š

```racket
(require (submod "demo.rkt" demo))
(hello "world")
```


å†çœ‹ ``module*`` çš„è¡Œä¸ºï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå†…éƒ¨ä½¿ç”¨è€Œå®šä¹‰çš„å­æ¨¡å—ï¼š

```racket
#lang racket  

(module demo (lib "racket/main.rkt")
  (define (add1 a) (+ a 1))
  (module demo-sub racket
    [display "in demo\n"]
    [define (hello a) (display (string-join (list "Hello" a "\n")))]
    [provide add1]
    [provide hello]
))

(define (add a b) (+ a b))

(require (submod 'demo demo-sub))
(module* main #f 
  (hello "world")
  (add1 10)
  (add 1 2))
```

``module*`` åŠ ä¸Š ``#f`` å¯ä»¥ä½¿è¿™ä¸ªå­æ¨¡å—çœ‹åˆ°å½“å‰æ¨¡å—çš„æ‰€æœ‰ç»‘å®šã€‚

è¿˜æœ‰ä¸€ä¸ª ``module+`` çš„å½¢å¼ï¼Œç±»å‹ ``module*`` åŠ  ``#f`` ï¼Œä½†æ˜¯ ``module+`` å¯ä»¥å¤šæ¬¡å£°æ˜ä¸€ä¸ªåå­—çš„å­æ¨¡å—ï¼Œæœ€ç»ˆå®ƒä»¬ä¼šè‡ªåŠ¨åˆå¹¶ï¼š

```racket
(module+ main
  (add 1 2))

(module+ main
  (hello "world"))

(module+ main
  (hello "world2"))
```


# Contracts #

## æ˜¯ä»€ä¹ˆ ##

*Contracts* çš„ä½œç”¨ï¼Œæ˜¯â€œçº¦æŸâ€ï¼Œå®ƒæè¿°äº†åƒå‡½æ•°çš„å…¥å‚ä¸ç»“æœæ˜¯ä»€ä¹ˆæ ·å­ã€‚â€œç±»å‹â€åªæ˜¯â€œçº¦æŸâ€çš„å­é›†ã€‚æ¯”å¦‚ï¼Œå…¶å®ƒè¯­è¨€ä¸­çš„ç±»å‹ï¼Œå¯ä»¥æŒ‡å®šè¯´ï¼Œâ€œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ•´æ•°â€ï¼Œä½†æ˜¯ *Contracts* å¯ä»¥åšåˆ°â€œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¤§äº 2 ä¸”å°äº 10 çš„æ•´æ•°â€ã€‚

æ›´ç¥å¥‡çš„æ˜¯ï¼Œåœ¨ *racket* ä¸­ï¼Œè¿™å¥— *Contracts* æœºåˆ¶ï¼Œå®Œå…¨æ˜¯å¯æ’æ‹”çš„ï¼Œå‰é¢ä»‹ç»çš„ä¸­ï¼Œå®Œå…¨ä¸ç®¡å®ƒï¼Œå®Œå…¨ä¸å½±å“ä»£ç å’ŒåŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨ã€‚è€Œä¸”ï¼Œå®ƒæ²¡æœ‰è‡ªå·±çš„â€œè¯­æ³•â€ï¼Œå®Œå…¨å’Œæ™®é€šä»£ç ä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯æ™®é€šä»£ç ã€‚

ç”¨æ™®é€šä»£ç å»çº¦æŸæ™®é€šä»£ç ã€‚

å…¶å®ƒè¯­è¨€ä¸­çš„ï¼Œæ¥å£ï¼Œæ³›å‹ï¼Œåœ¨ *racket* ä¸­æ²¡æœ‰ä»»ä½•ç‰¹æ®Šåœ°ï¼Œæ²¡æœ‰æ·»åŠ ä»»ä½•é¢å¤–è¯­æ³•åœ°ï¼Œå°±è¿™ä¹ˆå®ç°äº†ã€‚

*Contracts* çš„æ ·å­ï¼Œå¤§æ¦‚æ˜¯ï¼š

```racket
#lang racket  

(module demo racket
  (provide (contract-out [x positive?]))
  (define x 123))

(require 'demo)
x
```

``demo`` æ¨¡å—ä¸­ä¸Šï¼Œå£°æ˜äº†ä¸€ä¸ª *contract* ï¼Œè¯´ ``x`` éœ€è¦æ˜¯æ­£æ•°ã€‚è¿™æ—¶å¦‚æœå†™æˆ ``(define x -1)`` å°±ä¼šæŠ¥é”™äº†ã€‚




## ç»‘å®š ##

â€œç»‘å®šâ€å°±æ˜¯ ``define`` çš„é‚£äº›æ ‡è¯†ï¼Œå¯ä»¥ç»™å®ƒä»¬éƒ½æ·»åŠ ç›¸åº”çš„ *Contracts* ã€‚


```racket
#lang racket  

(define/contract
  x
  (or/c string? positive?)
  "hello")

(set! x -1) ;error
```

ä½¿ç”¨ ``define/contract`` åœ¨å®šä¹‰çš„åŒæ—¶ç»™å‡ºç›¸åº”çš„çº¦æŸã€‚

ä½¿ç”¨ ``or/c`` æˆ–è€… ``and/c`` å¯ä»¥ç»„ä»¶çº¦æŸçš„æ¡ä»¶ã€‚

å¦‚æœè¿‡ç¨‹ä¸­å‡ºç°äº†ä¸æ»¡è¶³ *Contracts* çš„æƒ…å†µï¼Œåˆ™ä¼šæŠ¥é”™ã€‚

## å‡½æ•° ##

### ä¸€èˆ¬å½¢å¼ ###

å‡½æ•°ä¸­ï¼Œæœ‰â€œå‚æ•°â€å’Œâ€œç»“æœâ€ï¼Œæ‰€ä»¥å‡½æ•°çš„ *Contracts* ä¹Ÿåº”è¯¥åŒ…å«è¿™ä¸¤éƒ¨åˆ†çš„ä¿¡æ¯ï¼Œä½¿ç”¨ ``->`` å‡½æ•°è¡¨ç¤º ã€‚

```racket
(module demo racket
  (provide (contract-out
             [add (-> positive? number? number?)]))
  (define (add a b) (+ a b)))

(require 'demo)
(add -1 2)
```

ä¸Šé¢ï¼Œæè¿°äº† ``add`` å‡½æ•°çš„å‚æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ­£æ•°ï¼Œæ‰€ä»¥ ``(add -1 2)`` ä¼šæŠ¥é”™ã€‚

``->`` ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å†™æˆ ``(positive? number? . -> . number?)`` æœ‰æ—¶ä¼šå¥½çœ‹ç‚¹ã€‚

å‡½æ•°ä¹Ÿå¯ä»¥åœ¨å®šä¹‰æ—¶ï¼Œç›´æ¥ç»™å‡ºçº¦æŸï¼š


```racket
(define/contract
  (add a b)
  (positive? number? . -> . number?)
  (+ a b))

(add 1 2)
(add -1 2)
```

### any any/c void? ###

- ``any`` ä»»ä½•ä¸œè¥¿ï¼Œç³»ç»Ÿéƒ½å¯ä»¥ä¸æ£€æŸ¥ã€‚
- ``void?`` ç©ºï¼Œæ¯”å¦‚æ²¡æœ‰è¿”å›ã€‚
- ``any/c`` ç±»å‹ ``any`` ï¼Œä½†æ˜¯å®ƒé™åˆ¶äº†ï¼Œåªæ˜¯èƒ½â€œå•å€¼â€ï¼Œä¸èƒ½æ˜¯â€œå¤šå€¼â€ã€‚


### é«˜é˜¶å‡½æ•° ###

åµŒå¥—ä½¿ç”¨ ``->`` å°±å¯ä»¥äº†ï¼š


```racket
(define/contract
  (base-add a)
  (number? . -> . (number? . -> . number?))
  (lambda (b) (+ a b)))

(define/contract
  (all-add func lst)
  (-> (-> number? number?) list? list?)
  (map func lst))

((base-add 10) 1)

(all-add (lambda (n) (+ n 1)) '(1 2 3))
```


### æç¤ºä¿¡æ¯ ###


```racket
(define/contract
  (add a b)
  (->
    (flat-named-contract
      'a
      (lambda (x) (and (> x 10) (< x 100)))
    )
    positive?
    positive?)
  (+ a b))

(add 1 -1)
```

åœ¨å¯¹åº”å‚æ•°/ç»“æœçš„ä½ç½®ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ ``flat-named-contract`` æ¥ç»™å‡ºå…·ä½“çš„æç¤ºï¼Œå¦åˆ™ï¼Œåƒ ``labmda`` è¿™ç§ï¼Œä¼šæ˜¾ç¤ºæˆä»£ç çš„ä½ç½®ã€‚


### å¯é€‰å‚æ•° ###

å¯é€‰å‚æ•°ï¼Œå°±æ˜¯å¸¦é»˜è®¤å€¼ï¼Œåœ¨å‚æ•°åˆ—è¡¨ååŠéƒ¨åˆ†çš„é‚£äº›å‚æ•°ã€‚è¿™ç§å½¢å¼ä¸‹ï¼Œéœ€è¦ä½¿ç”¨ ``->*`` æ¥åˆ¶å®šçº¦æŸã€‚ ``->*`` æœ‰ä¸¤éƒ¨åˆ†è¾“å…¥å‚æ•°ï¼Œç¬¬ä¸€ç»„æ˜¯å¿…é¡»å‚æ•°åˆ—è¡¨ï¼Œç¬¬äºŒç»„æ˜¯å¯é€‰å‚æ•°åˆ—è¡¨ã€‚

```racket
(define/contract
  (add a b [c 1] [d 1])
  (->* (number? number?)
       (number? number?)
       number?)
  (+ a b c d))

(add 1 1 3 3)
```


### ä¸å®šå‚æ•° ###

ä¸å®šå‚æ•°ï¼ŒæŒ‡å‚æ•°ä¸ªæ•°ä¸ç¡®å®šçš„æƒ…å†µã€‚

å®ƒåŒæ ·ä½¿ç”¨ ``->*`` ï¼Œä¸è¿‡éœ€è¦é…åˆä¸€ä¸ª ``#:rest`` å…³é”®è¯ã€‚

å‡½æ•°ä¸­å®šä¹‰ä¸å®šå‚æ•°ï¼Œæ˜¯ä½¿ç”¨çš„ ``.`` è¿™ä¸ªç¬¦å·æ¥åˆ†å‰²å‚æ•°ï¼š

```racket
(define
  (max-abs n . lst)
  (if (empty? lst) n
    [apply max-abs
           (max (abs n) (abs (first lst)))
           (rest lst)]))

(max-abs -10 -2 3 4)
```

åŠ ä¸Šçº¦æŸçš„è¯ï¼ˆä¼°è®¡åœ¨çº¦æŸä¸­åŠ ä¸€ä¸ªå€¼å¿…é¡»å¤§äº 0ï¼‰ï¼š

```racket
(define (list-and lst)
  (cond [(empty? lst) #t]
        [(eq? #f (first lst)) #f]
        [else (list-and (rest lst))]))

(define/contract
  (max-abs n . lst)
  (->* (number?)
       ()
       #:rest (lambda (lst) (list-and (map
                                        (lambda (x) (and (number? x) (> x 0)))
                                        lst)))
       ;#:rest (listof number?)
       number?)
  (if (empty? lst) n
    [apply max-abs
           (max (abs n) (abs (first lst)))
           (rest lst)]))

(max-abs 10 2 3 1)
```

``->*`` çš„å‚æ•°çš„å®Œæ•´å½¢å¼ï¼Œè¿˜å¯ä»¥å¤šä¸€ä¸ª ``#:rest`` ï¼Œåé¢æ˜¯ä¸€ä¸ªå‚æ•°æ˜¯åˆ—è¡¨çš„å‡½æ•°ã€‚

è¿™é‡Œ ``and`` æ˜¯ç‰¹æ®Šå‡½æ•°ï¼Œæ‰€ä»¥ ``(apply and ...)`` ä¼šæŠ¥é”™ã€‚


### å…³é”®è¯å‚æ•° ###


å…³é”®è¯å‚æ•°åœ¨çº¦æŸå®šä¹‰ä¸­ï¼Œä½¿ç”¨æ™®é€šçš„ ``->`` å°±å¯ä»¥äº†ï¼Œå®ƒæ”¯æŒå…³é”®è¯å‚æ•°ï¼š

```racket
(define/contract
  (minus a #:other b)
  (-> number? #:other number?
      number?)
  (- a b))

(minus #:other 10 1)
```

å…³é”®è¯å’Œå¯é€‰å‚æ•°ä¸€èµ·ï¼š

```racket
(define/contract
  (minus a #:other [b 10])
  (->* (number?)
       (#:other number?)
       number?)
  (- a b))

(minus 1 #:other 10)
```


### case-lambda ###

``case-lambda`` æ˜¯ä¸€ä¸ªæœ‰ç‚¹åƒæ¨¡å¼åŒ¹é…çš„åŠŸèƒ½ï¼Œçº¦æŸå®šä¹‰ä¸Šï¼Œå¯¹åº”ä½¿ç”¨ ``case->`` ã€‚

```racket
(define/contract
  add
  (case->
    (number? number? . -> . number?)
    (number? . -> . number?))
  (case-lambda
    [(a b) (+ a b)]
    [(a) (+ 100 a)]))

(add 1)
(add 1 2)
```

### ç»“æœä¸å‚æ•°æœ‰å…³è” ###

å¹¿ä¹‰åœ°è¯´ï¼Œè¿™ç§æƒ…å†µåº”è¯¥è¯´æˆâ€œå‚æ•°ä¸å‚æ•°ä¹‹é—´æœ‰ä¾èµ–ï¼Œæˆ–è€…ç»“æœä¸å‚æ•°ä¹‹é—´æœ‰ä¾èµ–â€ã€‚ååŠæ®µï¼Œå…¶å®æ˜¯ä¸€æ®µâ€œåºŸè¯â€ï¼Œå¯¹äºä¸€ä¸ªå‡½æ•°æ¥è¯´ï¼Œé™¤éæ˜¯ç‰¹åˆ«çš„åƒå¸¸æ•°å‡½æ•°ï¼Œå…¶å®ƒçš„å‡½æ•°ï¼ŒåŸºæœ¬ä¸Šç»“æœéƒ½ä¾èµ–äºå‚æ•°ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œè¯´çš„çº¦æŸä¸Šçš„æœºåˆ¶ï¼Œæ›´å¤šçš„æ˜¯åœ¨äºåœ¨ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬è‡ªå·±æƒ³æ€ä¹ˆå®šä¹‰è¿™ä¸ªçº¦æŸè€Œå·²ï¼Œçº¦æŸä¸æ˜¯æ£€æŸ¥å‡½æ•°å¯¹é”™ï¼Œè€Œæ˜¯ç«™åœ¨è°ƒç”¨è€…è§’åº¦ï¼Œé˜²èŒƒé”™è¯¯åœ°ä½¿ç”¨äº†ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªé”™è¯¯çš„â€œåŠ æ³•â€ï¼Œåœ¨å®ƒçš„å®ç°ä¸Šï¼Œ ``1 + 1 = 3`` ï¼Œçº¦æŸä¸æ˜¯è€ƒè™‘ ``1 + 1`` çš„ç»“æœå¯¹ä¸å¯¹ï¼Œè€Œæ˜¯è€ƒè™‘è°ƒç”¨ ``wrong-add`` è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒçš„ä¸¤ä¸ªå‚æ•°æ˜¯å¦ä¼ å¯¹äº†ï¼Œæœ‰æ—¶ï¼Œå®ƒç¡®å®ä¹Ÿæ˜¯è·Ÿä¸šåŠ¡æœ‰å…³çš„ã€‚

åŒæ ·ä¹Ÿæ˜¯åŠ æ³•ï¼Œ ``a + b`` ï¼Œå‡è®¾ï¼Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯ ``b > a`` ï¼Œè¿™ç§çº¦æŸï¼Œéœ€è¦ä½¿ç”¨ ``->i`` ï¼ˆ ``i`` è¡¨ç¤ºâ€œindy dependentâ€ï¼‰ï¼š

```racket
(define/contract
  (add a b)
  (->i ([a number?]
        [b (a) (and/c number? (>/c a))])
       (result (a b) (>=/c (+ a b))))
  (+ a b))

(add 1 2)
```

``->i`` ï¼Œåé¢æœ‰ä¸¤ç»„å‚æ•°ï¼Œç¬¬ä¸€ç»„ï¼Œæ˜¯å‡½æ•°çš„å‚æ•°ï¼ŒæŒ‰é¡ºåºï¼Œåé¢çš„å¯ä»¥ä¾èµ–å‰é¢çš„ã€‚ç¬¬äºŒç»„ï¼Œæ˜¯ç»“æœï¼Œå¯ä»¥ä¾èµ–æ‰€æœ‰å‡½æ•°å‚æ•°ã€‚

è¿™é‡Œé‡æ—©ç”³ä¸€ä¸‹ ``and/c``, ``>/c`` è¿™ç±»å‡½æ•°ã€‚å®ƒä»¬éƒ½æ˜¯é«˜é˜¶å‡½æ•°ï¼Œæœ€åçš„ç»“æœï¼Œæ˜¯ä»…æ¥å—ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚


### å‚æ•°è¢«ä¿®æ”¹çš„æƒ…å†µ ###

è¿™é‡Œè¦ä»‹ç»çš„ï¼Œè¿˜æ˜¯å¯¹ *result* çš„æ£€æŸ¥ï¼Œä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯å‚æ•°ä¼šè¢«å‡½æ•°æ›´æ”¹çš„æƒ…å†µã€‚

è¿™æ—¶ï¼Œä¹‹å‰çš„ ``(result (a b) (...))`` å°±æ²¡æœ‰åŠæ³•æ­£å¸¸å·¥ä½œäº†ï¼Œå› ä¸º ``a, b`` å·²ç»è¢«æ›´æ”¹ï¼Œæ²¡æœ‰åŸå§‹çŠ¶æ€ï¼Œå¯èƒ½å°±æ— æ³•ç”¨äºæ£€æŸ¥ç»“æœæ˜¯å¦æ­£å¸¸ã€‚è¿™é‡Œï¼Œ *racket* æä¾›çš„å·¥å…·ï¼Œä½œäº†ä¸€äº›ç»†å¾®çš„å˜åŒ–ï¼Œå…è®¸ ``(...)`` è¿™éƒ¨åˆ†å…ˆæ±‚å€¼ï¼Œå¦‚æœéœ€è¦ï¼Œå°±å¯ä»¥äº‹å…ˆæŠŠåŸå§‹çš„ ``a`` ``b`` ä¿å­˜ä¸€ä¸‹ï¼ˆæ³¨æ„ï¼Œæ±‚å€¼çš„ç»“æœæ˜¯ä¸€ä¸ªå•å‚æ•°å‡½æ•°ï¼Œè€Œå‡½æ•°çš„æ‰§è¡Œæ°¸è¿œæ˜¯åœ¨åŸå‡½æ•°è°ƒç”¨ä¹‹åçš„ï¼Œè¿™æ—¶æ‰æœ‰ ``result`` å€¼ï¼‰ï¼š

```racket
(define/contract
  (add1 a)
  (->i ([a box?])
       (_ (a) (begin
                     (display (list "A ->" (unbox a)))
                     (display "\n")
                     (lambda (x) (begin
                                   (display (list "B ->" x))
                                   (display "\n")
                                   #t)))))
  (set-box! a (+ 1 (unbox a)))
  (unbox a))

(define x (box 1))
(define r (add1 x))
(display (list "C ->" r))
```

è¿™ä¸ªä¾‹å­ï¼Œå†™æˆ ``_`` ï¼Œé‚£ä¹ˆåé¢çš„è¡¨è¾¾å¼å°±æ˜¯â€œå…ˆæ±‚å€¼â€ï¼Œä¼šè¾“å‡º "A -> 1" ã€‚å¦‚æœåƒåŸæ¥é‚£æ ·ï¼Œå†™æˆ ``result`` ï¼Œå°±ä¼šâ€œåæ±‚å€¼â€ï¼Œè¾“å‡º "A -> 2"ã€‚


### å¤šå€¼è¿”å› ###

å¤šå€¼è¿”å›ä»ç„¶ä½¿ç”¨ ``values`` å°±å¯ä»¥äº†ï¼Œ é€šè¿‡ ``values`` è¿”å›å¤šä¸ªå•å‚æ•°å‡½æ•°ï¼š

```racket
(define/contract
  (get)
  (-> (values number? number?))
  (values 10 20))

(get)
```


### å‚æ•°ä¹‹é—´ä¾èµ– ###

æœ€åä¸€ç§æƒ…å†µï¼Œç®—æ˜¯æœ€å¤æ‚çš„æƒ…å†µï¼ŒæŒ‡çš„æ˜¯ï¼Œå‚æ•°ä¹‹é—´äº’ç›¸æœ‰ä¾èµ–ï¼Œæ¯”å¦‚ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ç¬¦åˆçº¦æŸæ¡ä»¶ï¼Œæ˜¯è¦çœ‹ç¬¬äºŒä¸ªå‚æ•°çš„æƒ…å†µã€‚

```racket
(define (n-step proc inits)
  (let ([inc (apply proc inits)])
    (when inc
      (n-step proc [map (lambda (x) (+ x inc)) inits]))))


(define (f x)
  (printf "~s\n" x)
  (if (= x 0) #f -1))

(n-step f '(10 9))
```

ä¸Šé¢çš„ä¾‹å­ï¼Œè¿è¡Œæ˜¯ä¼šæŠ¥é”™çš„ã€‚å› ä¸º ``f`` å‡½æ•°ï¼Œå®ƒåªèƒ½æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯ ``(apply proc inits)`` ä¼šæŠŠ ``10`` å’Œ ``9`` ä¸¤ä¸ªå‚æ•°ä¼ ç»™å®ƒã€‚å¦‚æœè¦ä¸º ``n-step`` çš„ç¬¬ä¸€ä¸ªå‚æ•° ``proc`` å†™çº¦æŸï¼Œéœ€è¦åœ¨ ``->i`` æœºåˆ¶ä¸‹ï¼Œç”¨åˆ°ä¸“é—¨çš„ä¸€äº›åŠŸèƒ½æ–¹æ³•å»æè¿° ``proc`` çš„å‚æ•°ä¸ç»“æœï¼ˆå‡½æ•°çš„å®šä¹‰åŸŸå’Œå€¼åŸŸï¼‰ï¼š

```racket
(define/contract
  (n-step proc inits)
  (->i ([proc (inits) 
              (and/c (unconstrained-domain-> (or/c false/c number?))
                     (lambda (f) (procedure-arity-includes?
                                   f
                                   [length inits])))]
        [inits (listof number?)])
       ()
       any)
  (let ([inc (apply proc inits)])
    (when inc
      (n-step proc [map (lambda (x) (+ x inc)) inits]))))
```

é€šè¿‡ ``unconstrained-domain->`` æ£€æŸ¥å‡½æ•°çš„ç»“æœï¼Œè¿™é‡Œè¡¨ç¤ºç»“æœåªèƒ½æ˜¯ ``#f`` æˆ–è€…ä¸€ä¸ªæ•°å­—ã€‚

åœ¨æ£€æŸ¥å‡½æ•°æœ¬èº«çš„æ—¶å€™ï¼Œä½¿ç”¨äº† ``procedure-arity-includes?`` ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ£€æŸ¥æŒ‡å®šå‡½æ•°æ˜¯å¦å¯ä»¥æ¥æ”¶æŒ‡å®šä¸ªæ•°çš„å‚æ•°ã€‚


## ç»“æ„ ##

### ç»“æ„ç±»å‹çº¦æŸ ###

ç»“æ„ç±»å‹çš„çº¦æŸï¼Œåƒæ˜¯æ™®é€šçš„ç±»å‹å£°æ˜ï¼Œä¸è¿‡è¿™äº›çº¦æŸå¹¶ä¸æ˜¯ç”¨äºé™æ€åˆ†æçš„ï¼Œåªæ˜¯è¿è¡Œæ—¶çš„é¢å¤–ï¼Œè·Ÿæ‰‹å†™ ``if`` æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

```racket
(struct/contract
  point
  ([x number?] [y number?]))

(define (g) (point "a" 10))
```

è¿™ä¸ªä¾‹å­ï¼Œå®šä¹‰ ``point`` æ—¶ï¼ŒæŒ‡æ˜äº†å®ƒçš„ ``x`` å’Œ ``y`` éƒ½æ˜¯æ•°æ®ã€‚æ‰€ä»¥ ``(g)`` çš„è°ƒç”¨ï¼Œå°±ä¼šå‡ºé”™äº†ã€‚


### ç»“æ„å®ä¾‹å£°æ˜ ###

å®ä¾‹æŒ‡çš„å°±æ˜¯å‰é¢ä¾‹å­ä¸­ ``(g)`` è¿”å›çš„ä¸œè¥¿ï¼Œè¿˜æ˜¯åŒæ ·çš„ä¾‹å­ï¼š

```racket
(struct/contract
  point
  ([x number?] [y number?]))

(define/contract
  (g)
  (-> (struct/c point number? number?))
  (point 20 10))
```

åœ¨ ``(g)`` å‡½æ•°çš„å®šä¹‰ä¸­ï¼Œä½¿ç”¨ ``struct/c`` å£°æ˜äº†å®ƒçš„è¿”å›å€¼ï¼Œæ˜¯ä¸€ä¸ª ``point`` ç»“æ„ï¼Œå¹¶ä¸”ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯æ•°å­—ã€‚

è¿›ä¸€æ­¥ï¼Œä¸å‡½æ•°çš„ ``->i`` ç±»å‹ï¼Œä¹Ÿæœ‰ ``struct/dc`` ï¼Œå¯ä»¥å£°æ˜ç»“æ„çš„å„å±æ€§ä¹‹é—´æœ‰ä¾èµ–çš„æƒ…å†µçš„çº¦æŸè§„åˆ™ã€‚æ¯”å¦‚è¿˜æ˜¯ ``point`` ï¼Œè¦è®© ``y`` ä¸€å®šæ¯” ``x`` è¦å¤§çš„è¯ï¼š

```racket
(struct/contract
  point
  ([x number?] [y number?]))

(define/contract
  (g)
  (-> (struct/dc
        point
        [x number?]
        [y (x) (>/c x)]))
  (point 20 30))

(g)
```

## æŠ½è±¡çš„ Contracts ##

æŠ½è±¡çº¦æŸï¼Œç¬¬ä¸€çœ¼çœ‹ç€åƒæ³›å‹ï¼Œå¤šæƒ³æƒ³åˆåƒæ¥å£ã€‚å…¶å®å°±æ˜¯ä¸ç®¡æ˜¯çº¦æŸï¼Œè¿˜æ˜¯ä¸€ç»„å‡½æ•°ï¼Œå…¶æœ¬èº«å¯¹äºä¸€äº›å…ƒç´ ï¼Œå¹¶ä¸åœ¨æ„å®ƒå…·ä½“æ˜¯ä»€ä¹ˆï¼Œåªè¦èƒ½æ»¡è¶³æ¡ä»¶ï¼Œæ­£å¸¸å·¥ä½œå°±è¡Œäº†ï¼ˆåˆåƒé¸­å­ç±»å‹ï¼‰ã€‚è¿™é‡Œç”¨ *Hash Table* æ¥åšä¸€ä¸ªä¾‹å­ã€‚


```racket
(define a #hash([name . "a"] [age . 10]))

(define (get-name p)
  (hash-ref p 'name))
(define (get-age p)
  (hash-ref p 'age))

(provide
  (contract-out
    #:exists person
    [get-name (person . -> . symbol?)]
    [get-age (person . -> . number?)]))
```

è¿™ä¸ªä¾‹å­å½“ä¸­ï¼Œåªæ˜¯å®šä¹‰äº†ä¸€ä¸ªåä¸º ``a`` çš„ *Hash Table* ï¼Œç„¶å ``get-name`` å’Œ ``get-age`` éƒ½åªæ˜¯æ™®é€šçš„æ“ä½œã€‚åœ¨å®šä¹‰çº¦æŸçš„æ—¶å€™ï¼Œé€šè¿‡ ``#:exists`` ç»™äº†ä¸€ä¸ª ``person`` çš„æ¦‚å¿µï¼Œå½¢å¼ä¸Šï¼Œå°±çœ‹æˆäº† ``get-name`` å’Œ ``get-age`` éƒ½æ˜¯åœ¨é’ˆå¯¹ ``person`` è¿™ä¸ªä¸œè¥¿åœ¨åšæ“ä½œï¼Œ ``person`` å°±æ˜¯æŠ½è±¡å‡ºæ¥çš„ä¸œè¥¿ã€‚


## è‡ªå®šä¹‰ Contracts ##

TODO


# IO #

## åŸºæœ¬æ¦‚å¿µ ##

### æ–‡ä»¶ ###

*racket* ä¸­çš„ IOï¼ŒåŸºæœ¬ç”± *port* æ¥å®ç°ï¼Œè€Œ *port* çš„æ¦‚å¿µï¼Œç±»ä¼¼äº Python ä¸­çš„ *file* ï¼Œå®ƒå¯ä»¥æ˜¯æ–‡ä»¶ï¼Œsocketï¼Œpipeline ï¼Œç”šè‡³æ˜¯ä»»ä½• *file like* çš„ä¸œè¥¿ã€‚

```racket
#lang racket  

(define out (open-output-file "demo.txt" #:exists 'truncate))
(display "hello" out)
(close-output-port out)

(define in (open-input-file "demo.txt"))
(read-line in)
(close-input-port in)
```

*racket* ä¹Ÿæœ‰åƒ Python ä¸­çš„ *with* ä¸€æ ·çš„æ–¹æ³•ï¼š

```racket
(call-with-output-file "data.txt"
                       #:exists 'truncate
                       (lambda (out)
                         (display "hello" out)))

(call-with-input-file "data.txt"
                      (lambda (in)
                        (read-line in)))
```

å¯¹äºä¸å¤§çš„æ–‡ä»¶/portï¼Œå¯ä»¥ç›´æ¥ç”¨ ``port->string`` è¯»å–å®ƒï¼š

```racket
(define s (port->string (open-input-file "demo.txt") #:close? #t))
(printf "~a\n" s)
```


### å­—ç¬¦ä¸² ###

*file like* çš„ä¸œè¥¿ï¼Œåœ¨ *racket* ä¸­å°±ç®€å•äº†ï¼Œç›´æ¥ ``open-output-string`` å’Œ ``open-input-string`` å°±å¯ä»¥äº†ï¼š

```racket
(define port (open-output-string))
(display "hello" port)
(get-output-string port)

(read-line (open-input-string "here"))
```

ä»ä¸Šé¢ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘è§‰å¾—ä¸å¤ªæ–¹ä¾¿çš„ä¸€ç‚¹ï¼Œå°±æ˜¯åœ¨ *racket* ä¸­ï¼Œ output çš„ *port* å’Œ input çš„ *port* æ˜¯æ˜ç¡®åˆ†å¼€çš„ã€‚


### ç½‘ç»œ ###

ä¸€ä¸ªä¸€æ¬¡æ€§çš„ echo æœåŠ¡å¯ä»¥æ˜¯ï¼š

```racket
#lang racket  

(display "Begin\n")

(define server (tcp-listen 8888 4 #t))
(define-values (srv-in srv-out) (tcp-accept server))
(define content (read-line srv-in))

(display content)
(display "\n")

(display content srv-out)
(display "\n" srv-out)

(close-output-port srv-out)
(tcp-close server)

(display "End\n")
```

è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼Œ ``close-output-port`` ï¼Œå¦åˆ™å®¢æˆ·æ”¶ä¸åˆ°å“åº”ã€‚


### å­è¿›ç¨‹çš„è¾“å…¥è¾“å‡º ###

```racket
(define-values (sp out in err)
               (subprocess #f #f #f "/bin/ls" "-l"))
(printf "\n~a\n" (port->string out))
```


### å†…éƒ¨ç®¡é“ ###

è¿™é‡Œçš„ *pipe* ï¼Œåªæ˜¯ *racket* è‡ªå·±çš„å®ç°ï¼Œä¸æ˜¯æ“ä½œç³»ç»Ÿä¸Šçš„é‚£ä¸ªã€‚

```racket
(define-values (in out) (make-pipe))
(display "hello" out)
(close-output-port out)
(printf "~a\n" (read-line in))
```

è¿˜æ˜¯è¦è®°å¾— ``close-output-port`` ã€‚


### å½“å‰æ ‡å‡†è¾“å…¥è¾“å‡º ###

``display`` é»˜è®¤ä½¿ç”¨å½“å‰æ ‡å‡†è¾“å‡ºï¼Œ ``current-output-port`` ã€‚é”™è¯¯è¾“å‡º ``current-error-port`` ã€‚æ ‡å‡†è¾“å…¥ ``current-input-port`` ã€‚è¿™å‡ ä¸ªéƒ½æ˜¯å‡½æ•°ã€‚


```racket
(display "Input:\n")
(define s (read-line (current-input-port)))
(display s (current-output-port))
(display "\n" (current-output-port))
(display "error" (current-error-port))
```


## racket çš„ä¸‰ç§è¾“å‡ºæ ¼å¼ ##

è¿™éƒ¨åˆ†ï¼Œç›¸å¯¹å…¶å®ƒç¼–ç¨‹è¯­è¨€ï¼Œå°±è¦å¤æ‚ä¸€äº›äº†ã€‚

*racket* ä¸­çš„æ•°æ®ï¼Œåœ¨è¾“å‡ºçš„æ—¶å€™ï¼Œæœ‰ä¸‰ç§å½¢å¼å¯ä¾›é€‰æ‹©ã€‚ä¸ºä»€ä¹ˆæè¿™ä¹ˆå¤æ‚å‘¢ï¼Ÿ

ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä¸€ä¸ªå­—ç¬¦ä¸² ``hello`` ï¼Œå®ƒåœ¨è¾“å‡ºçš„æ—¶å€™ï¼š

```racket
hello
"hello"
```

å“ªç§æ˜¯ä½ å¸Œæœ›çš„ï¼Ÿæ²¡æœ‰ç¡®å®šçš„ç­”æ¡ˆã€‚

*racket* è¿˜æœ‰ä¸€ç§ *quote* ï¼Œæ¯”å¦‚ï¼š ``'(+ 1 1)`` ï¼Œæœ€åè¾“å‡ºçš„æ—¶å€™ï¼š

```racket
(+ 1 1)
'(+ 1 1)
```

å“ªç§æ˜¯ä½ å¸Œæœ›çš„ï¼Ÿ

æ‰€ä»¥ï¼Œ *racket* æä¾›äº†ä¸‰ç§è¾“å‡ºçš„å‡½æ•°ï¼Œå®ƒä»¬è¡Œä¸ºä¸Šï¼Œæœ‰ä¸€äº›å·®å¼‚ï¼š

- ``print`` ï¼Œæœ€â€œåŸå§‹â€ï¼Œä¸ REPL ä¸­çš„æ˜¾ç¤ºå®Œå…¨ä¸€æ ·çš„è¾“å‡ºã€‚
- ``write`` ï¼Œç»ˆç«¯å±‚é¢çš„â€œåŸå§‹â€ï¼Œå»æ‰äº† *quote* çš„æƒ…å†µã€‚
- ``display`` ï¼Œæœ€è´´è¿‘äººé˜…è¯»çš„å½¢å¼ï¼Œè¾“å‡ºå®é™…çš„å­—ç¬¦å­—èŠ‚ï¼Œæ²¡æœ‰é¢å¤–çš„å¼•å·ã€‚


ä»å­—ç¬¦ä¸²ï¼š

```racket
(print "hello\n")
(display "\n")
(write "hello\n")
(display "\n")
(display "hello\n")
```

åˆ°ç¬¦å·ï¼š

```racket
(print '(+ 1 "1"))
(display "\n")
(write '(+ 1 "1"))
(display "\n")
(display '(+ 1 "1"))
```

å°±æ¯”è¾ƒå®¹æ˜“åŒºåˆ†å®ƒä»¬äº†ã€‚


åœ¨ ``printf`` å‡½æ•°ä¸­ï¼Œå®ƒæœ‰ä¸‰ç§å ä½ç¬¦ï¼Œå¯¹åº”ä¸Šé¢çš„ä¸‰ç§è¾“å‡ºï¼š

- ``~a`` ï¼Œ ``display``
- ``~s`` ï¼Œ ``write``
- ``~v`` ï¼Œ ``print``


```racket
(printf "~v\n" '(+ 1 "1"))
(printf "~s\n" '(+ 1 "1"))
(printf "~a\n" '(+ 1 "1"))
```

ä¸Šé¢çš„ç»“æœæ˜¯ï¼š

```racket
'(+ 1 "1")
(+ 1 "1")
(+ 1 1)
```

ä½†æ˜¯ ``printf`` æœ¬èº«ï¼Œåˆæ˜¯ ``display`` çš„è¡Œä¸ºã€‚

ä¸Šè¿°çš„æ‰€æœ‰å‡½æ•°ï¼Œéƒ½æ˜¯å·¥ä½œåœ¨â€œå­—ç¬¦â€å±‚é¢çš„ï¼Œâ€œå­—èŠ‚â€å±‚é¢çš„æœ‰å…¶å®ƒå‡½æ•°ï¼Œå¦‚ ``read-byte`` ``write-byte`` ã€‚


## ç›´æ¥çš„åºåˆ—åŒ– ##

è¿™é‡Œåˆæ˜¯ä½“ç° lisp çš„â€œæ•°æ®å³ä»£ç ï¼Œä»£ç å³æ•°æ®â€çš„ä¸€ä¸ªåœ°æ–¹ã€‚åŒæ—¶ï¼Œä¹Ÿå’Œå‰é¢è®² *struct* æ—¶ï¼Œ *prefab*, *#:transparent* è¿™äº›è”ç³»èµ·æ¥äº†ã€‚

```racket
(define-values (in out) (make-pipe))
(define a '(+ 1 1))
(list? a)
(write a out)
(close-output-port out)
(define b (read in))
(list? b)
```

ä¸Šé¢æ˜¯ *quote* çš„æƒ…å†µï¼Œå…¶å®ƒçš„ *struct* ï¼Œä½¿ç”¨ *#:transparent* æ— æ³•ç›´æ¥å®ç°åºåˆ—åŒ–æ•ˆæœï¼Œéœ€è¦é…åˆå…¶å®ƒå·¥å…·ï¼ˆè¿™é‡Œå…ˆä¸è®¨è®ºäº†ï¼‰ï¼š

```racket
(struct point (x y) #:transparent)
(define p (point 1 2))
(point-x p)

(define-values (in out) (make-pipe))
(write p out)
(close-output-port out)
(define p2 (read in))
(vector? p2)
```

å³ä½¿è¿™æ ·ï¼Œ``read`` è¿›æ¥çš„ï¼Œä¹Ÿå®Œæˆäº† ``vector`` çš„è½¬åŒ–ã€‚

*prefab* çš„ç»“æ„ï¼Œå°±å¯ä»¥ç›´æ¥åºåˆ—åŒ–å¤„ç†äº†ï¼š

```racket
(struct point (x y) #:prefab)
(define p (point 1 2))

(define-values (in out) (make-pipe))
(write p out)
(close-output-port out)
(define p2 (read in))
(vector? p2)
(point? p2)
(point-x p2)
```


# æ­£åˆ™è¡¨è¾¾å¼ #

*racket* çš„æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰å¤ªå¤šç‰¹åˆ«çš„åœ°æ–¹ï¼Œä½¿ç”¨ä¸Šï¼Œåˆ†å­—ç¬¦ä¸²å’Œå­—èŠ‚ä¸²ã€‚

- å­—ç¬¦ä¸²ï¼š ``#px"\\d*?"``
- å­—èŠ‚ä¸²ï¼š ``#px#"\\d*?"``


è¿™é‡Œæ³¨æ„ï¼Œè¦ ``#px`` æ‰æ”¯æŒ ``\d`` ã€‚ ``#rx`` æ˜¯ä¸æ”¯æŒçš„ã€‚

å› ä¸º ``racket`` å­—ç¬¦ä¸²è§„åˆ™çš„é™åˆ¶ï¼Œè½¬ä¹‰æ—¶éœ€è¦å†™ä¸¤ä¸ª ``\`` ã€‚ä¹Ÿå¯ä»¥ä¸ç®¡è½¬ä¹‰ï¼Œä½¿ç”¨l ``regexp-quote`` å‡½æ•°ï¼š

```racket
(regexp-quote "list?") ; list\\?
```

æ­£åˆ™è¡¨è¾¾å¼çš„ä¸€èˆ¬æ“ä½œï¼Œéƒ½æœ‰å¯¹åº”çš„å‡½æ•°ï¼š

- æŸ¥è¯¢å’ŒåŒ¹é…ï¼š ``regexp-match-positions`` å’Œ ``regexp-match`` ï¼ŒåŠ ``regexp-match?`` ã€‚
- åˆ‡åˆ†ï¼š ``regexp-split`` ã€‚
- æ›¿æ¢ï¼š ``regexp-replace`` å’Œ ``regexp-replace*`` ï¼ˆå¸¦ ``*`` æ˜¯æ›¿æ¢æ‰€æœ‰ï¼Œå¦åˆ™åªæ›¿æ¢ç¬¬ä¸€ä¸ªï¼‰ã€‚


ä¸€äº›ä¾‹å­ï¼š

```racket
(define s (regexp-match #px"(.)(\\d+)" "abc123"))
(list-ref s 2)
```

æ›¿æ¢çš„ï¼š

```racket
(regexp-replace* #px"(.*?)(\\d+)" "abc123" "\\2+\\1")
```


# å¼‚å¸¸å’Œ call/cc #

## ä¼ ç»Ÿå¼‚å¸¸å’Œ catch ##

é€šè¿‡ ``with-handlers`` å’Œ ``exn:fail*`` ç³»åˆ—å¯¹è±¡ï¼Œå®Œæˆå¼‚å¸¸çš„æ•è·ï¼š

```racket
(with-handlers
  ([exn:fail:contract:divide-by-zero?
     (lambda (exc) (begin (display "here\n") 0))])
  (/ 1 0))
```

``with-handlers`` åé¢çš„å¼‚å¸¸ç±»å‹ï¼Œå¯ä»¥æœ‰å¤šä¸ªã€‚å½“ç„¶ï¼Œå‰ææ˜¯è¦å…ˆçŸ¥é“å¼‚å¸¸ç±»å‹ã€‚

ä¸æ¸…æ¥šçš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ ``exn:fail?`` ï¼š

```racket
(with-handlers
  ([exn:fail?
     (lambda (exc) (begin (display "here\n") 0))])
  (/ 1 0))
```

æŠ›å‡ºå¼‚å¸¸ä½¿ç”¨ ``error`` æˆ–è€… ``raise`` ã€‚ ``error`` ä¼šæŠŠå‚æ•°åŒ…è£…æˆ ``exn:fail`` ç»“æ„ï¼Œè€Œ ``raise`` ä¸ä¼šï¼š

```racket
(with-handlers
  ([exn:fail?
       (lambda (exc) (begin (printf "~a\n" (exn-message exc)) 0))])
         (error "Hello"))
```

ä½¿ç”¨ ``exn-message`` è·å–é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæ˜¯ ``raise`` ï¼Œå°±ä¸èƒ½ç›´æ¥ç”¨ ``exn:fail?`` ï¼Œéœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªåˆ¤æ–­ï¼š

```racket
(with-handlers
  ([(lambda (v) (eq? v "Hello"))
     (lambda (v) (begin (printf "~a\n" v) 0))])
  (raise "Hello"))
```


## Prompt å’Œ Abort ##

åœ¨ *racket* ä¸­ï¼Œæ¯”å¼‚å¸¸æ•è·æ›´é€šç”¨çš„ï¼Œæ˜¯ *Prompt* å’Œ *Abort* æœºåˆ¶ã€‚å®ƒä»¬ï¼Œç±»å‹å…¶å®ƒè¯­è¨€ä¸­çš„ *label* å’Œ *goto* ï¼Œä½†æ˜¯ä¼šåœ¨å¼‚å¸¸æœªæ•è·æ—¶ï¼Œè‡ªåŠ¨ *goto* åˆ°æœ€è¿‘çš„ä¸€ä¸ª *label* å¤„ã€‚

å®ƒçš„ç»“æ„ï¼Œåƒæ˜¯è¡¨è¾¾å¼ç‰ˆçš„ ``try`` ã€‚

```racket
(define tag (make-continuation-prompt-tag 'a))

(+ 1
   (call-with-continuation-prompt
     (lambda () [begin
                  (display "here\n")
                  (abort-current-continuation
                    tag
                    (lambda () 10))
                  (+ 1 1)])
     tag)
)
```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œå…ˆé€šè¿‡ ``make-continuation-prompt-tag`` åˆ›å»ºä¸€ä¸ª *label* ã€‚ç„¶åè¡¨è¾¾å¼ä¸­çš„éƒ¨åˆ†ï¼Œä½¿ç”¨ ``call-with-continuation-prompt`` *try* èµ·æ¥ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ *label* ã€‚

åœ¨ç¬¬ä¸€ä¸ªå‚æ•°å‡½æ•°ä¸­ï¼Œå°±å¯ä»¥æ§åˆ¶ ``abort-current-continuation`` å¸¦ç€ä¸€ä¸ªæ–°å‡½æ•°ï¼Œè·³åˆ°æŒ‡å®šçš„ *label* å¤„äº†ã€‚

``make-continuation-prompt-tag`` åˆ›å»ºçš„ *label*ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ ``default-continuation-prompt-tag`` æ–¹æ³•ä»£æ›¿ã€‚

``abort-current-continuation`` åªå¯ä»¥å¾€çˆ¶çº§çš„ *prompt* è·³ï¼Œå¯ä»¥è·¨çº§ï¼š

```racket
(define tag-a (make-continuation-prompt-tag 'a))
(define tag-b (make-continuation-prompt-tag 'b))

(+ 1
   (call-with-continuation-prompt
     (lambda () [begin
                  (display "A\n")
                  (call-with-continuation-prompt
                    (lambda () [begin
                                 (display "B\n")
                                 (abort-current-continuation
                                   tag-a
                                   (lambda () 10))])
                    tag-b)
                  (+ 1 1)])
     tag-a)
)
```


## Continuation, call/cc ##


æ ‡é¢˜ä¸­çš„ ``call/cc`` æ˜¯ ``call-with-current-continuation`` ï¼Œå®ƒæ˜¯ *scheme* çš„ä¸€ä¸ªä¼ ç»ŸæŠ€è‰ºï¼Œåœ¨ *racket* ä¸­æœ‰äº†ä¸€äº›æ‰©å±•ï¼Œç”¨ ``call-with-composable-continuation`` ã€‚

*Continuation* ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¡¨è¾¾å¼ä¸­çš„â€œå‘ä½â€ã€‚æ¯æ¬¡å¡«å‘çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥å¯¹ä¸€ä¸ªå³å®šçš„è¡¨è¾¾å¼é‡æ–°æ±‚å€¼ã€‚

æˆ‘ä¸ªäººç†è§£ï¼Œå®ƒå…¶å®æ˜¯å¯¹è¡¨è¾¾å¼æ±‚å€¼è¿‡ç¨‹çš„ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„å‡½æ•°åŒ–è¡¨è¾¾è½¬æ¢ã€‚

ç†è§£ ``call/cc`` ä¸éš¾ï¼Œä¹Ÿä¸éœ€è¦ç”¨ç½‘ä¸Šé‚£äº›â€œç†è®ºâ€ï¼ˆå…¶å®æ˜¯æˆ‘ä¸æ‡‚ï¼‰ï¼š

```racket
(define ff void)

(+ 1 (call/cc (lambda (f)
                (set! ff f)
                (f 2)
                (printf "here"))))

(printf "|~a|\n" (ff 10))
```

ä¸Šé¢ä»£ç çš„ç»“æœï¼Œå¯¹äºå¤§éƒ¨ä»½åˆæ¬¡æ¥è§¦ ``call/cc`` çš„äººæ¥è¯´ï¼Œè‚¯å®šä¼šéå¸¸æ„å¤–çš„ã€‚

å…¶å®æ ¸å¿ƒå¾ˆç®€å•ï¼š

**å½“ ``call/cc`` çš„ ``lambda`` çš„é‚£ä¸ª ``f`` è¢«è°ƒç”¨æ—¶ï¼Œä¼šä¸­æ–­å½“å‰è¡¨è¾¾å¼çš„æ±‚å€¼è¿‡ç¨‹ï¼ŒåŒæ—¶è°ƒç”¨çš„ç»“æœä¼šä½œä¸ºå½“å‰è¡¨è¾¾å¼çš„ç»“æœã€‚**

ç†Ÿæ‚‰ *yield* çš„äººï¼Œåœ¨è¿™é‡Œè‚¯å®šæœ‰ä¼¼æ›¾ç›¸ä¼¼çš„æ„Ÿè§‰ï¼Œè™½ç„¶å…·ä½“å½¢å¼ä¸Šæœ‰å·®å¼‚ï¼Œä¸è¿‡éƒ½æ˜¯è¡¨è¾¾å¼çš„å€¼ï¼Œæ˜¯ç”±å¦å¤–ä¸€ä¸ªåœ°æ–¹çš„â€œå‚æ•°â€æ‰€å½±å“ä¸å†³å®šçš„ã€‚

``f`` çš„è¡Œä¸ºæœ¬èº«æ˜¯å¥½ç†è§£çš„ï¼Œæ•´ä¸ªè¡¨è¾¾å¼ï¼ŒæŠŠè‡ªå·±è¿™éƒ¨åˆ†æ¢ä¸ªå‘ï¼Œå˜æˆä¸€ä¸ªå•å‚æ•°çš„æ ·å­ã€‚æ¯”å¦‚ï¼Œä¸Šé¢çš„ä»£ç ï¼Œ ``f`` ç›¸å½“äºï¼š ``lambda (hole) (+ 1 hole)`` ã€‚

æ‰§è¡Œæµç¨‹çš„æ”¹å˜ï¼Œè·Ÿ ``call/cc`` è¡¨è¾¾å¼æœ¬èº«æ²¡æœ‰å…³ç³»ï¼Œå…³é”®æ˜¯é‚£ä¸ª ``f`` æœ‰æ²¡æœ‰è¢«è°ƒç”¨ã€‚ ``|~a|`` é‚£é‡Œï¼Œå› ä¸º ``ff`` è¢«è°ƒç”¨äº†ï¼Œæ‰€ä»¥ ``printf`` å°±æ²¡æœ‰ä½œç”¨äº†ã€‚ï¼ˆ ``printf`` æœ¬èº«æ²¡æœ‰è¿”å›å€¼ï¼Œ ``ff`` è°ƒç”¨åï¼Œå®ƒçš„è¿”å›å€¼å°±ä½œä¸ºè¡¨è¾¾å¼è¿”å›å€¼ã€‚åŒæ—¶ï¼Œå› ä¸º ``ff`` çš„è°ƒç”¨ï¼Œ ``printf`` çš„è°ƒç”¨è¿‡ç¨‹å³å½“å‰è¡¨è¾¾å¼çš„æ±‚å€¼è¿‡ç¨‹è¢«ä¸­æ–­ï¼Œä¹Ÿå°±çœ‹ä¸åˆ° ``printf`` çš„æ•ˆæœäº†ã€‚ï¼‰

æ¥ä¸‹æ¥ï¼Œè¦å°è¯•ææ¸…æ¥šï¼Œæˆ‘ä»¬è¯´çš„â€œå½“å‰è¡¨è¾¾å¼â€ï¼Œåˆ°åº•æ˜¯ä¸€ä¸ªæ€æ ·çš„èŒƒå›´ã€‚è¿˜æ˜¯åˆšæ‰çš„ä¾‹å­ï¼š

```racket
(define ff void)

(+ 1 (call/cc (lambda (f)
                (set! ff f)
                (f 2)
                (printf "here"))))

(printf ">~a<\n"
        (printf "|~a|\n" (ff 10)))

(printf ">~a<\n"
        (printf "|~a|\n" 100))
```

è¾“å‡ºçš„ç»“æœæ˜¯ï¼š

```text
3
11
|100|
>#<void>< 
```

ç»“æœéªŒè¯äº†åˆšæ‰å¯¹ ``printf`` è¿‡ç¨‹çš„è§£é‡Šã€‚åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œâ€œå½“å‰è¡¨è¾¾å¼â€çš„èŒƒå›´ï¼Œæ˜¯ä¸€è¡Œæ•´ä¸ªè¡¨è¾¾å¼ã€‚ç”šè‡³é¢å¤–æŠŠå®ƒåŒ…åˆ°ä¸€ä¸ªå‡½æ•°é‡Œä¹Ÿä¸è¡Œï¼š

```racket
(define ff void)

(+ 1 (call/cc (lambda (f)
                (set! ff f)
                (f 2))))

(define (get-result) (ff 10))

(printf ">~a<\n"
        (printf "|~a|\n" (get-result)))
```

è¿™ä¸ªè¡Œä¸ºï¼Œå°±è·Ÿæ˜¯åœ¨â€œæ­£åˆ™åºâ€æ±‚å€¼ä¸€æ ·ã€‚ï¼ˆäº‹å®æ˜¯å¦å¦‚æ­¤æˆ‘å¹¶ä¸çŸ¥é“ï¼‰

é‚£æ˜¯å¦å¯ä»¥æ§åˆ¶è¿™ä¸ªâ€œå½“å‰è¡¨è¾¾å¼â€çš„èŒƒå›´å‘¢ï¼Ÿ *racket* ä¸­æ˜¯å¯ä»¥çš„ï¼Œå°±æ˜¯ç”¨å‰é¢ä»‹ç»è¿‡çš„ *prompt* çš„ *tag* ï¼š

```racket
(define tag-a (make-continuation-prompt-tag 'a))
(define ff void)

(call-with-continuation-prompt
  (lambda () 
    [+ 1 (call/cc (lambda (f)
                    (set! ff f)
                    (f 2)) tag-a)]) tag-a)

(define (get-result) (ff 10))

(printf ">~a<\n"
        (call-with-continuation-prompt
          [lambda ()
            (printf "|~a|\n" (get-result))] tag-a))
```

è¿™ä¸ªä»£ç ï¼Œ``ff`` è¢«æ‰§è¡Œåï¼Œå®ƒçš„ç»“æœä¼šä½œä¸º ``tag-a`` è¿™ä¸ª *tag* èŒƒå›´çš„è¡¨è¾¾å¼çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ç»“æœæ˜¯ï¼š

```text
3
>11<
```

äº†è§£äº† ``call/cc`` ï¼Œå†çœ‹ *racket* ä¸­çš„ ``call-with-composable-continuation`` ã€‚

æœ€å¤§çš„åŒºåˆ«æ˜¯ï¼Œ ``call-with-composable-continuation`` ä¼šåœ¨å¯¹ ``f`` çš„è°ƒç”¨æ±‚å€¼åï¼Œå†æŠŠè¿™ä¸ªæ±‚å€¼å¸¦å›åŸè¡¨è¾¾å¼ï¼Œç»§ç»­æ±‚å€¼ã€‚è€Œ ``f`` çš„è°ƒç”¨æ±‚å€¼ï¼Œæ˜¯å¦è¿”å›ï¼Œå–å†³äºç”¨æˆ·æ˜¯å¦æ˜¾å¼åœ°è®¾ç½®äº† *label* ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œåˆ™ä¸è¿”å›ã€‚å¦åˆ™ï¼Œè¿”å›ï¼Œè¿™æ ·ï¼Œå®é™…ä¸Šå°±ä¼šè¿”å›å¤šä¸ªå€¼ã€‚

```racket
(define tag-a (make-continuation-prompt-tag 'a))
(define tag-b (make-continuation-prompt-tag 'b))
(define ff void)
(define fff void)

(call-with-continuation-prompt
  (lambda ()
    (+ 1 (call-with-composable-continuation
           (lambda (f)
             (set! ff f)
             (f 20)) tag-a))
    ) tag-a)


(+ 1
   (call-with-continuation-prompt
     (lambda ()
       (+ 5
          (call-with-composable-continuation
            (lambda (f)
              (set! fff f)
              (f 20)
              #;100)
            tag-b))
       ) tag-b))



(define (get-result) (fff 100))
(printf ">~a<\n"
        (printf "|~a|\n" (get-result)))

```

``tag-b`` ï¼Œè‡ªå·±æ±‚å€¼é‚£é‡Œï¼Œçœ‹ä¸¤æ­¥ï¼š

- ç¬¬ä¸€æ­¥ï¼Œ ``(f 20)`` ï¼Œæ ¹æ® ``tag-b`` çš„èŒƒå›´ï¼Œä¼šå¾—åˆ° 25 çš„ç»“æœã€‚
- ç¬¬äºŒï¼ŒæŠŠ 25 æ›¿æ¢åˆ° ``call-with-composable-continuation`` çš„ä½ç½®ï¼Œæ±‚å€¼åŸè¡¨è¾¾å¼ï¼Œå¾—åˆ° 31 ã€‚


è¿™é‡ŒæŒ»æœ‰æ„æ€çš„ä¸€ç‚¹ï¼Œå°±æ˜¯ ``(f 20)`` å®ƒæ±‚å€¼çš„èŒƒå›´ï¼Œå’Œç»“æœæ›¿æ¢çš„èŒƒå›´ï¼Œæ˜¯ä¸åŒçš„ã€‚

å†çœ‹ ``(fff 100)`` ï¼Œ ``fff`` æ˜¯ ``f`` çš„èŒƒå›´ï¼Œæ‰€ä»¥æ˜¯ ``tag-b`` çš„èŒƒå›´ï¼Œé‚£ä¹ˆ ``(fff 100)`` çš„æ±‚å€¼ç»“æœåº”è¯¥æ˜¯ ``105`` ã€‚ ``get-result`` ç»“æœæ˜¯ 105 ï¼Œå†æŠŠå®ƒä»£å›åŸè¡¨è¾¾å¼æ±‚å€¼ï¼Œå°±å¾—åˆ°äº†ï¼š

```text
|105|
>#<void><
```

å¦‚æœä¸è®¾å®š ``call-with-continuation-prompt`` ï¼Œé‚£ä¹ˆä¼šè¿”å›ä¸¤æ¬¡ï¼š

```racket
(define ff void)

(+ 1 (+ 5
        (call-with-composable-continuation
          (lambda (f)
            (set! ff f)
            (f 100)))))

(printf ">~a<\n"
        (printf "|~a|\n" (ff 1000)))
```

æœ€åçš„è¾“å‡ºä¼šæ˜¯ï¼š

```racket
106
112
1006
|1006|
>#<void>< 
```

``(f 100)`` å’Œ ``(ff 1000)`` éƒ½è¿”å›äº†ä¸¤æ¬¡ï¼Œä¸€æ¬¡æ˜¯ä»£æ›¿æ•´ä¸ªè¡¨è¾¾å¼è¿”å›ï¼Œå¦ä¸€æ¬¡æ˜¯ä½œä¸ºè‡ªå·±è¿”å›ï¼ŒåŸè¡¨è¾¾å¼å†ç»§ç»­æ±‚å€¼ã€‚

ä¸é»˜è®¤æŠŠâ€œä»£æ›¿æ•´ä¸ªè¡¨è¾¾å¼è¿”å›â€è¿™ä¸ªå–æ¶ˆæ‰ï¼Œè¿™ä¸ªè®¾è®¡æŒ»è°œçš„ã€‚


# è¿­ä»£ #

## for ##

è™½ç„¶ä¸æ˜¯å¿…é¡»ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œ *racket* æä¾›äº† ``for`` ä¸€ç°‡çš„æ–¹æ³•ã€‚

```racket
(for ([i '(1 2 3)])
  (display i)
  (display i))
```

å¾ˆç›´è§‚çš„ä½¿ç”¨æ–¹å¼ã€‚ä¹Ÿå¯ä»¥åƒ ``map`` ä¸€æ ·ï¼Œä½¿ç”¨ ``for/list`` ï¼Œå®ƒä¼šè¿”å›åˆ—è¡¨ï¼š

```racket
(for/list ([i '(1 2 3)])
  (+ i i))
```

å¤šä¸ªåˆ—è¡¨ï¼ˆå–æœ€çŸ­ï¼‰ï¼š

```racket
(for/list ([i '(1 2 3)]
           [j '(a b c d e)])
  (list i j))
```

ä¼ ç»ŸåµŒå¥—ï¼ˆå¾—åˆ° ``1 a, 1 b, 1 c, 2 a ...``ï¼‰ï¼š

```racket
(for*/list ([i '(1 2)]
            [j '(a b c)])
  (list i j))
```

åˆ—è¡¨æ¨å¯¼ï¼š

```racket
(for/list ([i '(1 2)]
           #:when (= i 1)
           [j '(a b c)]
           #:unless (equal? j 'b))
  (list i j))
```

``for/vector`` å’Œ ``for*/vector`` å¯ä»¥ç”Ÿæˆå‘é‡ç»“æœã€‚


*reduce* çš„èƒ½åŠ›æ˜¯ ``for/fold`` å’Œ ``for*/fold``ï¼š

```racket
(for/fold ([sum 0]) ([i '(1 2 3)])
  (+ sum i))
```

æ³¨æ„ï¼Œ ``for/fold`` åé¢å¤šäº†ä¸€ä¸ªå‚æ•°ã€‚



## åˆ¤æ–­ä¸æŸ¥æ‰¾ ##

``for/and`` å’Œ ``for/or`` å¯ä»¥å®ç° ``all`` å’Œ ``some`` çš„èƒ½åŠ›ï¼š

```racket
(for/and ([i '(1 2 3)])
  (i . = . 2))

(for/or ([i '(1 2 3)])
  (i . = . 2))
```

``for/first`` å’Œ ``for/last`` æ˜¯ ``find`` ä¹‹ç±»çš„èƒ½åŠ›ï¼Œå®ƒéœ€è¦é…åˆåˆ—è¡¨æ¨å¯¼ï¼Œ *body* æ˜¯è¿”å›äº†ï¼š

```racket
(for/first ([i '(1 2 3 2)]
            #:when (= i 2))
           (list i (+ 1 i)))

(for/last ([i '(1 2 3 2)]
            #:when (not (= i 2)))
           (list i (+ 1 i)))
```


## ä¸­æ–­ ##

*racket* è¿˜ä¸“é—¨æä¾›äº†ä¸€ä¸ª ``break`` ï¼Œå®ç°è¿­ä»£ä¸­çš„ä¸­æ–­è¡Œä¸ºï¼š

```racket
(for ([i '(1 2 3)]
      #:break (= i 3))
  (display i))
```


## åºåˆ—ç”Ÿæˆ ##

``in-range`` æ˜¯ä¸€ä¸ªå…¸å‹çš„åºåˆ—ç”Ÿæˆå™¨ï¼Œä¸‰ä¸ªå‚æ•°æ˜¯ *start/end/step* ï¼š

```racket
(for ([i (in-range 10)])
  (display i))

(display "\n")

(for ([i (in-range 1 5)])
  (display i))

(display "\n")

(for ([i (in-range 1 20 3)])
  (display i))
```


## å…³äºæ€§èƒ½ ##

è¿­ä»£çš„å¯¹è±¡ï¼Œè™½ç„¶æ˜¯æ™®é€šçš„ *list* æˆ–è€… *vector* *string* ä¹‹ç±»éƒ½æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œï¼š

```racket
(for/list ([i '(1 2 3)])
  (+ i 1))

(for/vector ([i #(1 2 3)])
  (+ i 1))
```

åœ¨è¿­ä»£ä¸­ï¼Œæ›´å¿«çš„å¤„ç†æ–¹å¼ï¼Œæ˜¯æŠŠåˆ—è¡¨è½¬æˆå¯¹åº”çš„â€œåºåˆ—â€ï¼Œä½¿ç”¨ ``in-list`` ``in-vector``ï¼š

```racket
(for/list ([i '(1 2 3)])
  (+ i 1))

(for/vector ([i #(1 2 3)])
  (+ i 1))
```

å¯èƒ½æ˜¯å‡ºäºå…¸å‹çš„æƒ°æ€§è®¡ç®—è€ƒè™‘å§ã€‚

# åˆ†æ”¯åŒ¹é…å’Œæ¨¡å¼åŒ¹é… #

## åˆ†æ”¯åŒ¹é… ##

ç¡®å®šå½¢å¼çš„åŒ¹é…ï¼Œå¯ä»¥ç›´æ¥å†™ï¼š

```racket
(define val 1)
(match val
  [1 'one]
  [2 'two])

(match '(2 3)
  ['(1 2) 1]
  ['(2 3) 2])

(struct point (x y))
(match (point 2 3)
  [(point 1 2) "one"]
  [(point 2 3) "two"])

(match (point 2 4)
  [(point 1 2) "one"]
  [(point 2 3) "two"]
  [_ "other"])
```


## æ¨¡å¼åŒ¹é… ##

å¸¦å‚æ•°çš„åŒ¹é…é¡¹ï¼Œä¼šæŒ‰â€œæ¨¡å¼â€è¿›è¡Œå‚æ•°åŒ¹é…ï¼š

```racket
(define (m val)
  (match val
    [(list x) (+ x 1)]
    [(list x y) (+ x y)]))

(m '(1))
(m '(1 2))
```

ç»“æ„ä½“ï¼š

```racket
(struct point (x y))
(struct point2 (x y))

(define (m val)
  (match val
    [(point x y) (+ x y)]
    [(point2 x y) (* x y)]))

(m (point 2 3))
(m (point2 2 3))
```

*list* å’Œ *vector* æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥ç”¨ ``...`` è¡¨ç¤ºç›¸åŒçœç•¥ ï¼š

```racket
(define (m val)
  (match val
    [(list 1 2 ...) 'first]
    [(list 2 ...) 'second]
    [_ 'other]))

(m '(1 2 2 2)) ;first
(m '(2 3)) ;other
```

æˆ–è€…åŠ ä¸Šå‚æ•°ï¼Œä½œä¸åŒå‚æ•°çš„åŒ¹é…ï¼š

```racket
(define (m val)
  (match val
    [(list 1 x ...) (apply + x)]
    [(list 2 x ...) x]
    [_ 'other]))

(m '(1 2 3 3))
(m '(2 3))
```


# ç±»å’Œå¯¹è±¡ #

# ç»„ä»¶ Unit #

# åå°„ #

# å® #


